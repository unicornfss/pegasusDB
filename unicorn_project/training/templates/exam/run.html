{% extends "base.html" %}

{% block title %}{{ course_type.name }} — Exam {{ exam.exam_code|slice:"-2:" }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 820px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">{{ course_type.name }} — Exam {{ exam.exam_code|slice:"-2:" }}</h1>
    <div class="badge bg-dark" id="timer">--:--</div>
  </div>

  <div class="mb-2 text-muted">Question {{ q_index }} of {{ q_total }}</div>

  <form method="post" class="card">
    {% csrf_token %}
    <input type="hidden" name="examcode" value="{{ exam.exam_code }}">
    <input type="hidden" name="attempt" value="{{ attempt.id }}">
    <input type="hidden" name="q" value="{{ q_index }}">

    <div class="card-body">
      <p class="lead mb-3">{{ question.text }}</p>

      <div class="list-group">
        {% for a in answers %}
          <label class="list-group-item list-group-item-action d-flex align-items-center gap-2">
            <input class="form-check-input me-2" type="radio" name="answer" value="{{ a.id }}"
                {% if selected_pk == a.id %}checked{% endif %}>
            <span>{{ a.text }}</span>
        </label>
        {% endfor %}
      </div>
    </div>

    <div class="card-footer d-flex justify-content-between">
      <button name="prev" class="btn btn-outline-secondary" {% if q_index == 1 %}disabled{% endif %}>Back</button>

      {% if q_index < q_total %}
        <button name="next" class="btn btn-primary">Save & next</button>
      {% else %}
        <button name="finish" class="btn btn-success">Finish exam</button>
      {% endif %}
    </div>
  </form>

  <p class="small text-muted mt-2">Your answers are saved as you move through the questions.</p>
</div>

<script>
(function(){
  // Countdown from remaining seconds supplied by server
  let remaining = {{ remaining|default:0 }};
  const timerEl = document.getElementById('timer');

  function render(){
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    timerEl.textContent = m + ':' + (s < 10 ? '0' : '') + s;
  }
  render();

  const tick = setInterval(function(){
    remaining -= 1;
    if (remaining <= 0) {
      clearInterval(tick);
      // Auto-finish when client timer hits zero (server also enforces)
      const url = "{% url 'delegate_exam_finish' %}?examcode={{ exam.exam_code }}&attempt={{ attempt.id }}";
      window.location.href = url;
      return;
    }
    render();
  }, 1000);
})();
</script>
{% endblock %}
