{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-2">{{ title }}</h3>
<p class="text-muted">
  {{ day.booking.course_type.name }} — {{ day.date|date:"j M Y" }}
</p>

<div class="d-flex gap-2 mb-2">
  <a class="btn btn-outline-primary btn-sm" href="{% url 'instructor_delegate_new' day.pk %}">
    <i class="bi bi-person-plus"></i> Add delegate
  </a>

  <a class="btn btn-outline-primary btn-sm"
     href="{% url 'instructor_day_registers_pdf' day.id %}"
     download>
    <i class="bi bi-filetype-pdf"></i> Export PDF
  </a>
</div>

{% if any_dob_mismatch %}
<div class="alert alert-warning py-2">
  Some dates of birth don’t match what was entered on previous day(s). Look for the red “DOB?” badge.
</div>
{% endif %}

<div class="alert alert-info py-2 mb-2 small d-flex justify-content-between align-items-center">
  <div>
    <i class="bi bi-arrow-repeat"></i>
    This page auto-refreshes every 5 seconds. Updates pause while your mouse is over the list.
    <span id="last-updated-time" class="ms-2"></span>
  </div>
  <div id="auto-refresh-status" class="d-none">
    Updating…
  </div>
</div>

<div class="table-responsive mb-3">
  <table class="table table-sm align-middle table-striped table-hover">
    <thead>
      <tr>
        <th style="width:22%">Name</th>
        <th style="width:14%">Date of birth</th>
        <th style="width:18%">Job title</th>
        <th style="width:32%">Notes</th>
        <th class="d-none d-lg-table-cell" style="width:8%">Employee ID</th>
        <th style="width:6%" class="text-center">Health</th>
        <th style="width:10%" class="text-end">Actions</th>
      </tr>
    </thead>

    <tbody id="reg-body"
           data-poll-url="{% url 'instructor_day_registers_poll' day.id %}">
      {% for r in rows %}
        <tr class="js-row-link">
          <td class="position-relative">
            {{ r.obj.name }}
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          <td class="position-relative">
            {{ r.obj.date_of_birth|date:"d/m/Y"|default:"—" }}
            {% if r.dob_mismatch %}
              <span class="badge bg-danger ms-1" title="Does not match previous day{% if r.dob_expected %} (expected {{ r.dob_expected|date:'d/m/Y' }}){% endif %}">
                DOB?
              </span>
            {% endif %}
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          <td class="position-relative">
            {{ r.obj.job_title|default:"—" }}
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          <td class="text-muted position-relative">
            {% if r.obj.notes %}
              {{ r.obj.notes|truncatechars:140 }}
            {% else %}
              —
            {% endif %}
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          <td class="d-none d-lg-table-cell position-relative">
            {{ r.obj.employee_id|default:"—" }}
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          <td class="text-center position-relative">
            <span class="badge {{ r.health_class }}" title="{{ r.health_title }}">
              {{ r.health_symbol }}
            </span>
            <a href="{% url 'instructor_delegate_edit' r.obj.pk %}"
              class="stretched-link"
              aria-label="Edit {{ r.obj.name }}">
              <span class="visually-hidden">Edit</span>
            </a>
          </td>

          {# Keep actions above the stretched links so buttons still work #}
          <td class="text-end position-relative" style="z-index: 3;">
            <a class="btn btn-outline-primary btn-sm" href="{% url 'instructor_delegate_edit' r.obj.pk %}">
              Edit
            </a>
            <form method="post"
                  action="{% url 'instructor_delegate_delete' r.obj.pk %}"
                  class="d-inline js-delete-form">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm">
                Delete
              </button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" class="text-muted">No delegates yet.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# ===== EMAIL REGISTER BOX (below the list) ===== #}
<div class="card mb-3">
  <div class="card-body py-3">
    <div class="mb-2 fw-semibold">Email attendance registers to:</div>

    <form id="send-register-form"
          method="post"
          action="{% url 'instructor_send_register_pdf' day.id %}">
      {% csrf_token %}

      <div class="row g-3 align-items-center">
        <div class="col-md-auto">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="to_location" id="to_location">
            <label class="form-check-label" for="to_location">
              Location contact
              {% if day.booking.training_location and day.booking.training_location.email %}
                <span class="text-muted">({{ day.booking.training_location.email }})</span>
              {% endif %}
            </label>
          </div>
          <div class="form-check mt-1">
            <input class="form-check-input" type="checkbox" name="to_business" id="to_business">
            <label class="form-check-label" for="to_business">
              Business contact
              {% if day.booking.business and day.booking.business.email %}
                <span class="text-muted">({{ day.booking.business.email }})</span>
              {% endif %}
            </label>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-2">
            <a href="#" id="toggle-other" class="small text-decoration-underline">+ Send to another authorised email</a>
          </div>
          <div id="other-wrap" class="border rounded p-2 d-none">
            <div class="mb-2">
              <label for="other_email" class="form-label mb-1 small">Other email address</label>
              <input type="email" class="form-control form-control-sm" name="other_email" id="other_email" placeholder="name@example.com">
            </div>
            <div class="mb-2">
              <label for="other_reason" class="form-label mb-1 small">Reason (required)</label>
              <textarea class="form-control form-control-sm" name="other_reason" id="other_reason" rows="2"
                        placeholder="Why does this person need the register?"></textarea>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="other_confirm" name="other_confirm">
              <label class="form-check-label small" for="other_confirm">
                I confirm this person is authorised to receive delegate attendance information.
              </label>
            </div>
          </div>
        </div>

        <div class="col-md-auto">
          <button id="send-register-btn" type="submit" class="btn btn-primary">
            <i class="bi bi-send"></i> Send PDF
          </button>
        </div>

        {% if register_email_logs %}
          <div class="col-md small text-muted">
            Already sent {{ register_email_logs|length }} time{{ register_email_logs|length|pluralize }}.
          </div>
        {% endif %}
      </div>
    </form>

    {% if register_email_logs %}
      <div class="mt-2 small">
        <div class="text-muted">Recent sends:</div>
        <ul class="mb-0">
          {% for log in register_email_logs|slice:":5" %}
            <li>{{ log.created_at|date:"d/m/Y H:i" }} to {{ log.recipients }}{% if log.reason %} — {{ log.reason }}{% endif %}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</div>
{# ===== END EMAIL BOX ===== #}

<div class="mt-2 small">
  <strong>Key:</strong>
  {% for sym, cls, text in legend %}
    <span class="badge {{ cls }}">{{ sym }}</span> {{ text }}{% if not forloop.last %} &middot; {% endif %}
  {% endfor %}
</div>

<a class="btn btn-secondary mt-3" href="{{ back_url }}">
  <i class="bi bi-arrow-left"></i> Back to booking
</a>

<script>
  // Confirm before delete
  document.querySelectorAll('.js-delete-form').forEach(function (form) {
    form.addEventListener('submit', function (e) {
      if (!confirm('Delete this delegate? This cannot be undone.')) {
        e.preventDefault();
      }
    });
  });

  // Email panel behaviour
  (function(){
    const form = document.getElementById('send-register-form');
    if (!form) return;
    const btn  = document.getElementById('send-register-btn');
    const toLoc = document.getElementById('to_location');
    const toBus = document.getElementById('to_business');
    const toggleOther = document.getElementById('toggle-other');
    const otherWrap = document.getElementById('other-wrap');
    const otherEmail = document.getElementById('other_email');
    const otherReason = document.getElementById('other_reason');
    const otherConfirm = document.getElementById('other_confirm');

    toggleOther.addEventListener('click', function(e){
      e.preventDefault();
      otherWrap.classList.toggle('d-none');
    });

    function validEmail(v){
      // simple but good-enough validation (server also validates)
      return !!v && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function isOtherValid(){
      if (otherWrap.classList.contains('d-none')) return false;
      return validEmail(otherEmail.value.trim()) &&
             otherReason.value.trim().length > 0 &&
             otherConfirm.checked;
    }

    function updateBtn(){
      const anyChecked = (toLoc && toLoc.checked) || (toBus && toBus.checked) || isOtherValid();
      btn.disabled = !anyChecked;
    }

    [toLoc, toBus, otherEmail, otherReason, otherConfirm].forEach(el => {
      if (!el) return;
      el.addEventListener('change', updateBtn);
      el.addEventListener('keyup', updateBtn);
      el.addEventListener('input', updateBtn);
    });
    updateBtn();
  })();
</script>

<script>
  // Silent rows refresh: fetch fragment and swap <tbody> without touching the email form
  (function(){
    const tbody = document.getElementById('reg-body');
    if (!tbody) return;

    const pollUrl = tbody.dataset.pollUrl;
    const INTERVAL = 5000;

    const lastUpdatedEl = document.getElementById('last-updated-time');
    const statusEl = document.getElementById('auto-refresh-status');

    let isHovering = false;
    tbody.addEventListener('mouseenter', () => { isHovering = true; });
    tbody.addEventListener('mouseleave', () => { isHovering = false; });

    function formatTime(d) {
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    function setLastUpdatedNow() {
      if (lastUpdatedEl) lastUpdatedEl.textContent = `Last updated: ${formatTime(new Date())}`;
    }
    // set an initial value
    setLastUpdatedNow();

    // Don't refresh while user is interacting with table inputs or delete forms
    function isBusy() {
      const a = document.activeElement;
      if (!a) return false;
      const isField = /^(INPUT|TEXTAREA|SELECT|BUTTON)$/.test(a.tagName);
      return isField && tbody.contains(a);
    }

    async function tick() {
      try {
        if (!document.hidden && !isBusy() && !isHovering) {
          if (statusEl) statusEl.classList.remove('d-none');

          const resp = await fetch(pollUrl, {headers: {"X-Requested-With": "XMLHttpRequest"}});
          if (resp.ok) {
            const data = await resp.json();
            if (data && typeof data.html === "string") {
              // Only replace if content actually changed
              if (tbody.getAttribute('data-last') !== data.html) {
                tbody.innerHTML = data.html;
                tbody.setAttribute('data-last', data.html);
                setLastUpdatedNow();
              }
            }
          }
        }
      } catch (e) { /* swallow errors silently */ }
      finally {
        if (statusEl) statusEl.classList.add('d-none');
      }
      setTimeout(tick, INTERVAL);
    }

    setTimeout(tick, INTERVAL);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) setTimeout(tick, 200);
    });
  })();
</script>

<style>
  /* Make whole row feel clickable */
  tr.js-row-link { cursor: pointer; }

  /* Stronger hover highlight than default Bootstrap */
  tr.js-row-link:hover > * {
    box-shadow: inset 0 0 0 9999px rgba(13, 110, 253, 0.10); /* subtle blue wash */
  }

  /* Keyboard focus outline (accessibility) */
  tr.js-row-link:focus-within > * {
    box-shadow: inset 0 0 0 9999px rgba(13, 110, 253, 0.14);
    outline: 2px solid rgba(13, 110, 253, 0.35);
    outline-offset: -2px;
  }
</style>
{% endblock %}
