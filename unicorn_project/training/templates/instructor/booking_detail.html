{% extends "base.html" %}
{% load dict_extras %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-2 d-flex align-items-center gap-2">
  {{ booking.course_type.name }}
  {% if booking.course_reference %}
    <span class="badge bg-light text-dark border">Ref: {{ booking.course_reference }}</span>
  {% endif %}
</h3>

{% with st=booking.status %}
  {% if st == "scheduled" %}
    <span class="badge bg-info text-dark mb-3">Scheduled</span>
  {% elif st == "in_progress" %}
    <span class="badge bg-dark mb-3">In progress</span>
  {% elif st == "awaiting_closure" %}
    <span class="badge mb-3" style="background-color:#6f42c1;color:#fff">Awaiting instructor closure</span>
  {% elif st == "completed" %}
    <span class="badge bg-success mb-3">Completed</span>
  {% elif st == "cancelled" %}
    <span class="badge bg-warning text-dark mb-3">Cancelled</span>
  {% else %}
    <span class="badge bg-secondary mb-3">{{ booking.get_status_display|default:booking.status }}</span>
  {% endif %}
{% endwith %}

{% if is_locked %}
  <div class="alert alert-warning d-flex align-items-center gap-2">
    <i class="bi bi-lock"></i>
    This course is closed. All tabs are read-only except <strong>Invoicing</strong>.
  </div>
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-4">

      {# LEFT COLUMN ------------------------------------------------------- #}
      <div class="col-lg-4">

        {# Location / business card #}
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-light d-flex align-items-center">
            <i class="bi bi-geo-alt me-2"></i>
            <strong>Course location</strong>
          </div>
          <div class="card-body">

            <div class="mb-3">
              <div class="text-muted small">Business</div>
              <div>{{ booking.business.name }}</div>
            </div>

            <div class="mb-0">
              <div class="text-muted small">Location</div>

              <div>
                {{ booking.training_location.name|default:"(TBC)" }}<br>

                {% if booking.training_location %}
                  {{ booking.training_location.address_line }}<br>
                  {{ booking.training_location.town }} {{ booking.training_location.postcode }}<br>

                  {% with addr=booking.training_location.address_line|add:", "|add:booking.training_location.town|add:" "|add:booking.training_location.postcode %}
                    <a class="small d-block mb-2"
                      target="_blank" rel="noopener"
                      href="https://www.google.com/maps/search/?api=1&query={{ addr|urlencode }}">
                      View in Google Maps
                    </a>
                  {% endwith %}

                  {# === Precise location display === #}
                  {% if booking.precise_lat and booking.precise_lng %}
                    <div class="small text-success mt-2">
                      <a
                        href="https://www.google.com/maps/dir/?api=1&destination={{ booking.precise_lat }},{{ booking.precise_lng }}"
                        target="_blank"
                        rel="noopener"
                        class="text-success text-decoration-none"
                      >
                        <i class="bi bi-crosshair2 me-1"></i>
                        <strong>Precise location:</strong> {{ booking.precise_lat }}, {{ booking.precise_lng }}
                      </a>
                    </div>
                  {% else %}
                    <div class="small text-muted mt-2">
                      No precise map location set.
                    </div>
                  {% endif %}

                  {% if not is_locked %}
                    <div class="mt-3 d-flex flex-wrap gap-2">
                      <button type="button"
                        class="btn btn-outline-success btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#MapPickerModal">
                        <i class="bi bi-geo-alt-fill me-1"></i> View / adjust precise location
                      </button>

                      {% if booking.precise_lat and booking.precise_lng %}
                        <form method="post" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="reset_precise_location">
                          <button class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset to admin point
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  {% endif %}

                {% endif %}
              </div>

            </div>
          </div>
        </div>

        {# Calendar card #}
        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex align-items-center">
            <i class="bi bi-calendar3 me-2"></i>
            <strong>Calendar</strong>
          </div>
          <div class="card-body">

            {% if gcal_links %}
              <div>
                <div class="text-muted small mb-2">Add to Google Calendar</div>

                <div class="d-flex flex-wrap gap-2">
                  {% for day in gcal_links %}
                    <a href="{{ day.url }}" target="_blank"
                      class="btn btn-google-cal btn-sm d-inline-flex align-items-center">
                      <i class="bi bi-calendar-event me-1"></i>
                      Day {{ forloop.counter }} ‚Äì {{ day.date|date:"j M Y" }}
                    </a>
                  {% endfor %}
                </div>
              </div>
              <hr class="my-3">
            {% endif %}

            <div>
              <div class="text-muted small">Download .ics file</div>

              <a href="{% url 'download_booking_ics' booking.pk %}"
                class="btn btn-outline-success btn-sm mt-2 d-inline-flex align-items-center">
                <i class="bi bi-calendar-plus me-1"></i>
                Download .ics
              </a>
            </div>

          </div>
        </div>

      </div>

      {# MIDDLE COLUMN ----------------------------------------------------- #}
      <div class="col-lg-4">

        <div class="card shadow-sm mb-3">
          <div class="card-header bg-light d-flex align-items-center">
            <i class="bi bi-person-badge me-2"></i>
            <strong>Instructor</strong>
          </div>
          <div class="card-body">

            <div class="mb-3">
              <div class="text-muted small">Instructor</div>
              <div>{{ booking.instructor.name }}</div>
            </div>

            {# Hidden instructor fee reveal #}
            <div class="mb-0">
              <div class="text-muted small mb-2">Fee</div>

              <div class="fee-reveal-wrap">
                <button id="reveal-fee-btn"
                        type="button"
                        class="btn btn-outline-dark btn-sm"
                        data-fee-url="{% url 'booking-fee' booking.pk %}">
                  Tap to reveal your fee
                </button>

                <div id="fee-popover" class="fee-popover mt-2" role="status" aria-live="polite">
                  <span id="fee-text"></span>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex align-items-center">
            <i class="bi bi-telephone me-2"></i>
            <strong>Location contact</strong>
          </div>
          <div class="card-body">

            {% if booking.training_location %}
              <div>
                {{ booking.training_location.contact_name|default:"‚Äî" }}<br>
                {% if booking.training_location.telephone %}
                  <a href="tel:{{ booking.training_location.telephone }}">
                    {{ booking.training_location.telephone }}
                  </a><br>
                {% endif %}
                {% if booking.training_location.email %}
                  <a href="mailto:{{ booking.training_location.email }}">
                    {{ booking.training_location.email }}
                  </a>
                {% endif %}
              </div>
            {% else %}
              <div>‚Äî</div>
            {% endif %}

          </div>
        </div>

      </div>

      {# RIGHT COLUMN (NOTES) ---------------------------------------------- #}
      <div class="col-lg-4">

        <div class="card shadow-sm h-100">
          <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="bi bi-journal-text me-2"></i>
              <strong>Notes</strong>
            </div>

            {% if booking.course_type.onedrive_folder_link %}
              <a href="{{ booking.course_type.onedrive_folder_link }}"
                target="_blank"
                rel="noopener"
                class="btn btn-outline-primary btn-sm">
                <i class="bi bi-cloud"></i> Materials
                <i class="bi bi-box-arrow-up-right ms-1"></i>
              </a>
            {% endif %}
          </div>

          <div class="card-body">
            <form id="booking-notes-form" method="post" class="h-100 d-flex flex-column">
              {% csrf_token %}

              <input type="hidden" name="action" id="id_precise_action" value="">
              <input type="hidden" name="precise_lat" id="id_precise_lat" value="{{ booking.precise_lat }}">
              <input type="hidden" name="precise_lng" id="id_precise_lng" value="{{ booking.precise_lng }}">

              <div class="text-muted small mb-2">Course notes</div>

              {% if is_locked %}
                {{ notes_form.booking_notes }}
                <script>
                  document.addEventListener('DOMContentLoaded', function(){
                    var ta = document.getElementById('id_booking_notes');
                    if (ta){ ta.setAttribute('readonly','readonly'); ta.classList.add('bg-light'); }
                  });
                </script>
              {% else %}
                {{ notes_form.booking_notes }}
              {% endif %}

              {% for err in notes_form.booking_notes.errors %}
                <div class="text-danger small">{{ err }}</div>
              {% endfor %}

              {% if not is_locked %}
                <div class="mt-3">
                  <button class="btn btn-primary btn-sm"
                          onclick="document.getElementById('id_precise_action').value='save_notes'">
                    <i class="bi bi-check2"></i> Save notes
                  </button>
                </div>
              {% endif %}
            </form>
          </div>
        </div>

      </div>
</div>

<ul class="nav nav-tabs mt-3" id="bookingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="days-tab" data-bs-toggle="tab"
            data-bs-target="#days-pane" type="button" role="tab"
            aria-controls="days-pane" aria-selected="true">
      Course days / registers
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="assessments-tab" data-bs-toggle="tab"
            data-bs-target="#assessments-pane" type="button" role="tab"
            aria-controls="assessments-pane" aria-selected="false">
      Assessments
    </button>
  </li>

  {% if has_exam %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="exams-tab" data-bs-toggle="tab"
            data-bs-target="#exams-pane" type="button" role="tab"
            aria-controls="exams-pane" aria-selected="false">
      Exams
    </button>
  </li>
  {% endif %}

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="feedback-tab" data-bs-toggle="tab"
            data-bs-target="#feedback-pane" type="button" role="tab"
            aria-controls="feedback-pane" aria-selected="false">
      Feedback
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="closure-tab" data-bs-toggle="tab"
            data-bs-target="#closure-pane" type="button" role="tab"
            aria-controls="closure-pane" aria-selected="false">
      Course closure
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="invoicing-tab" data-bs-toggle="tab"
            data-bs-target="#invoicing-pane" type="button" role="tab"
            aria-controls="invoicing-pane" aria-selected="false">
      Invoicing
    </button>
  </li>
</ul>

<div class="tab-content border border-top-0 rounded-bottom p-3" id="bookingTabsContent">
  <!-- Pane: Course days / registers -->
  <div class="tab-pane fade show active" id="days-pane" role="tabpanel" aria-labelledby="days-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:160px">Date</th>
            <th style="width:120px">Start</th>
            <th style="width:120px" class="text-center">Delegates</th>
            <th style="width:160px" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for d in day_rows %}
              <tr class="{% if d.warn %}table-warning{% endif %}">
              <td>{{ d.date }}</td>
              <td>{% if d.start_time %}{{ d.start_time|time:"H:i" }}{% else %}‚Äî{% endif %}</td>
              <td class="text-center"><span class="badge bg-secondary">{{ d.n }}</span></td>
              <td class="text-end">
                <a class="btn btn-outline-primary btn-sm" href="{{ d.edit_url }}">
                  <i class="bi bi-people"></i> View / edit
                </a>
              </td>
            </tr>
              {% if d.warn %}
                <tr class="table-warning">
                  <td colspan="4" class="small text-danger">
                    ‚ö†Ô∏è Date of birth mismatch detected on this register
                    ({{ d.warn_count }} item{{ d.warn_count|pluralize }}).
                    Please open the register and correct the affected delegate(s).
                  </td>
                </tr>
              {% endif %}


          {% empty %}
            <tr><td colspan="4" class="text-muted">No days created for this booking.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pane: Assessments -->
  <div class="tab-pane fade" id="assessments-pane" role="tabpanel" aria-labelledby="assessments-tab" tabindex="0">
    {% include "instructor/_assessment_matrix_inner.html" %}
  </div>

  {% if has_exam %}
  <!-- Pane: Exams (only when course type has exams) -->
  <div class="tab-pane fade" id="exams-pane" role="tabpanel" aria-labelledby="exams-tab" tabindex="0">
     <div id="exams-refresh-indicator" class="text-end small text-muted" style="opacity:0; transition:opacity .25s;">Updating‚Ä¶</div>

    {% if course_exams %}

      <div class="alert alert-info py-2 small" style="font-size:0.85rem;">
        <strong>Note:</strong> Live exam results refresh automatically when you are not interacting with this section.<br>
        Move your mouse away from the table to allow refreshing.
      </div>

      <div class="accordion" id="examAccordion">

        {% for ex in course_exams %}
          {% with seq=ex.sequence code=ex.exam_code %}
          <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="ex-h-{{ seq }}">
              <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                      data-bs-toggle="collapse" data-bs-target="#ex-c-{{ seq }}"
                      aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                      aria-controls="ex-c-{{ seq }}">
                Exam {{ seq }} ‚Äî {{ ex.title }} <span class="ms-2 small text-muted">({{ code }})</span>
              </button>
            </h2>
            <div id="ex-c-{{ seq }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                 aria-labelledby="ex-h-{{ seq }}" data-bs-parent="#examAccordion">
              <div class="accordion-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm align-middle m-0">
                    <thead>
                      <tr>
                        <th>Delegate</th>
                        <th style="width: 120px;">DOB</th>
                        <th style="width: 90px;">Attempt</th>
                        <th style="width: 110px;" class="text-center">Score</th>
                        <th style="width: 90px;"  class="text-center">%</th>
                        <th style="width: 120px;">Result</th>
                        <th class="text-end" style="width: 260px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% with atts=attempts_by_exam|get_item:seq %}
                        {% if atts %}
                          {% for att in atts %}
                            <tr>
                              <td>{{ att.delegate_name|default:"Delegate" }}</td>
                              <td>
                                {% if att.date_of_birth %}
                                  {{ att.date_of_birth|date:"j M Y" }}
                                {% else %}
                                  <span class="text-muted">‚Äî</span>
                                {% endif %}
                              </td>
                              <td>{{ att.attempt_number|default:"1" }}</td>

                              <!-- Score (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at %}
                                  {% if att.total_questions %}
                                    {{ att.score_correct }}/{{ att.total_questions }}
                                  {% else %}
                                    {{ att.score_correct }}
                                  {% endif %}
                                {% else %}
                                  <span class="text-muted">‚Äî</span>
                                {% endif %}
                              </td>

                              <!-- Percentage (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at and att.total_questions %}
                                  {% widthratio att.score_correct att.total_questions 100 %}%
                                {% else %}
                                  <span class="text-muted">‚Äî</span>
                                {% endif %}
                              </td>

                              <td>
                                {% if att.finished_at %}
                                  {% if att.passed %}
                                    <span class="badge bg-success">Pass</span>
                                  {% elif att.viva_eligible %}
                                    <span class="badge bg-warning text-dark">Viva</span>
                                  {% else %}
                                    <span class="badge bg-danger">Fail</span>
                                  {% endif %}
                                {% else %}
                                  <span class="badge bg-info text-dark">In progress</span>
                                {% endif %}
                              </td>
                              <td class="text-end">

                                <a class="btn btn-sm btn-outline-primary"
                                  href="{% url 'instructor_attempt_review' att.id %}?back={{ booking.id }}&tab=exams">
                                  Review exam
                                </a>

                                <a class="btn btn-sm btn-outline-secondary"
                                  href="{% url 'instructor_attempt_incorrect' att.id %}?back={{ booking.id }}&tab=exams">
                                  See incorrect & authorise re-test
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        {% else %}
                          <tr><td colspan="7" class="text-muted p-3">No attempts yet for this exam.</td></tr>
                        {% endif %}
                      {% endwith %}
                    </tbody>

                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info my-2">No exams defined for this course type.</div>
    {% endif %}

  </div>
{% endif %}


    <!-- Pane: Feedback -->
    <div class="tab-pane fade" id="feedback-pane" role="tabpanel"
        aria-labelledby="feedback-tab" tabindex="0">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Feedback</h5>
        <div class="btn-group btn-group-sm">
          <a href="{% url 'instructor_feedback_pdf_all' booking.id %}"
            class="btn btn-primary btn-sm"
            target="_blank" rel="noopener">
            <i class="bi bi-file-earmark-pdf me-1"></i>
            All forms PDF
          </a>
          <a href="{% url 'instructor_feedback_pdf_summary' booking.id %}"
            class="btn btn-outline-secondary btn-sm"
            target="_blank" rel="noopener">
            <i class="bi bi-file-earmark-pdf me-1"></i>
            Summary PDF
          </a>
        </div>
      </div>

      {% include "instructor/booking_feedback.html" %}
    </div>


  <!-- Pane: Course closure -->
<div class="tab-pane fade" id="closure-pane" role="tabpanel" aria-labelledby="closure-tab" tabindex="0">

  {% if not is_locked %}
  <form method="post" class="mt-3" id="closure-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="autosave_closure">

    <!-- Registers -->
    <div class="mb-3">
      <label class="form-label"><strong>Course registers</strong></label>
      <select class="form-select" name="course_registers_status" required>
        <option value="">-- Select --</option>
        <option value="completed" {% if booking.course_registers_status == "completed" %}selected{% endif %}>
          Complete
        </option>
        <option value="send_later" {% if booking.course_registers_status == "send_later" %}selected{% endif %}>
          Will send separately
        </option>
      </select>
    </div>

    <!-- Assessments -->
    <div class="mb-3">
      <label class="form-label"><strong>Assessment matrix</strong></label>
      <select class="form-select" name="assessment_matrix_status" required>
        <option value="">-- Select --</option>
        <option value="completed" {% if booking.assessment_matrix_status == "completed" %}selected{% endif %}>
          Completed
        </option>
        <option value="send_later" {% if booking.assessment_matrix_status == "send_later" %}selected{% endif %}>
          Will send separately
        </option>
      </select>
    </div>

        <!-- Close Button -->
        {% if can_close_course %}
          <button type="submit" class="btn btn-danger" onclick="
            document.querySelector('#closure-form input[name=action]').value = 'final_close_course';">
            ‚úÖ Close course & send documents
          </button>
        {% endif %}

        <!-- ‚úÖ VIEW CERTIFICATES BUTTON (ALWAYS AVAILABLE) -->
        <a
          href="{% url 'instructor_booking_certificates' booking.pk %}"
          target="_blank"
          class="btn btn-secondary ms-2"
        >
          üìÑ View Certificates
        </a>

  </form>

  {% else %}
    <div class="alert alert-success mt-3">
      ‚úÖ Course has already been closed.
    </div>
  {% endif %}

</div>


   <!-- Pane: Invoicing -->
  <div class="tab-pane fade" id="invoicing-pane" role="tabpanel" aria-labelledby="invoicing-tab" tabindex="0">
    {% include "instructor/_invoicing_tab.html" %}
  </div>
</div>

<a href="{% url 'instructor_bookings' %}" class="btn btn-secondary">Back to My bookings</a>

{# === Map Picker Modal (copied from admin view) === #}
<div class="modal fade" id="MapPickerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Precise Map Location</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="map" style="height: 500px; width: 100%; border: 1px solid #ccc;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="save-map-location" class="btn btn-primary">Save location</button>
      </div>
    </div>
  </div>
</div>

<script>
let map, marker;

function initMapPicker() {
  const initialLat = parseFloat('{{ booking.precise_lat|default:"" }}') || 52.5;
  const initialLng = parseFloat('{{ booking.precise_lng|default:"" }}') || -2.1;

  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: initialLat, lng: initialLng },
    zoom: 14,
  });

  marker = new google.maps.Marker({
    position: { lat: initialLat, lng: initialLng },
    map: map,
    draggable: true,
  });

  map.addListener("click", (e) => {
    marker.setPosition(e.latLng);
  });

  document.getElementById("save-map-location").onclick = function () {
    const pos = marker.getPosition();
    document.getElementById("id_precise_lat").value = pos.lat();
    document.getElementById("id_precise_lng").value = pos.lng();
    const form = document.getElementById("booking-notes-form");
    document.getElementById("id_precise_action").value = "update_precise_location";
    form.submit();
  };
}

document.addEventListener("DOMContentLoaded", function () {
  const modal = document.getElementById("MapPickerModal");
  modal.addEventListener("shown.bs.modal", initMapPicker);
});
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}"></script>


<!-- END new script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const regSelect = document.querySelector('select[name="course_registers_status"]');
  const assessSelect = document.querySelector('select[name="assessment_matrix_status"]');
  const form = document.getElementById("closure-form");

  function autoSubmit() {
    const activeTab = document.querySelector(".nav-link.active");
    if (activeTab) {
      const target = activeTab.getAttribute("data-bs-target");
      if (target) {
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "active_tab";
        hidden.value = target.replace("#", "");
        form.appendChild(hidden);
      }
    }
    form.submit();
  }

  regSelect.addEventListener("change", autoSubmit);
  assessSelect.addEventListener("change", autoSubmit);
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const hash = window.location.hash;
  if (!hash) return;
  const tabTrigger =
    document.querySelector('button[data-bs-target="' + hash + '"]') ||
    document.querySelector(hash + '[data-bs-toggle="tab"]');
  if (tabTrigger && window.bootstrap && bootstrap.Tab) {
    new bootstrap.Tab(tabTrigger).show();
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var examsTabBtn = document.getElementById('exams-tab');
  var examsPane   = document.getElementById('exams-pane');
  var indicator   = document.getElementById('exams-refresh-indicator');

  console.log('[ExamsRefresh] DOM ready');

  if (!examsPane) {
    console.log('[ExamsRefresh] exams-pane not found ‚Äî abort');
    return;
  }

  var timer = null;

  function isPaneActive() {
    return examsPane.classList.contains('active') && examsPane.classList.contains('show');
  }

  function isUserInteracting() {
    if (examsPane.matches(':hover')) return true;
    var ae = document.activeElement;
    return !!(ae && examsPane.contains(ae));
  }

  function showIndicator(on) {
    if (indicator) indicator.style.opacity = on ? '1' : '0';
  }

  async function refreshExams() {
    if (!isPaneActive()) return;
    if (isUserInteracting()) return;

    console.log('[ExamsRefresh] refreshing‚Ä¶');
    showIndicator(true);

    try {
      var url = window.location.href.split('#')[0];
      var res = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), {
        cache: 'no-store',
        headers: { 'X-Requested-With': 'fetch' }
      });

      if (!res.ok) return;

      var html = await res.text();
      var tmp = document.createElement('div');
      tmp.innerHTML = html;

      var freshPane = tmp.querySelector('#exams-pane');
      if (!freshPane) return;

      var freshSections = freshPane.querySelectorAll('.accordion-collapse[id^="ex-c-"]');
      var changed = false;

      freshSections.forEach(function (freshSection) {
        var id = freshSection.id;
        var currentSection = examsPane.querySelector('#' + CSS.escape(id));
        if (!currentSection) return;

        var freshTbody = freshSection.querySelector('table tbody');
        var currTbody  = currentSection.querySelector('table tbody');

        if (freshTbody && currTbody) {
          var freshHTML = freshTbody.innerHTML.trim();
          if (currTbody.innerHTML.trim() !== freshHTML) {
            currTbody.innerHTML = freshHTML;
            changed = true;
          }
        }
      });

      console.log('[ExamsRefresh] done' + (changed ? ' (content updated)' : ' (no changes)'));
    } catch (e) {
      console.log('[ExamsRefresh] error:', e);
    } finally {
      setTimeout(function(){ showIndicator(false); }, 300);
    }
  }

  function start() {
    if (!timer) {
      console.log('[ExamsRefresh] starting interval');
      timer = setInterval(refreshExams, 5000);
    }
  }

  function stop() {
    if (timer) {
      console.log('[ExamsRefresh] stopping interval');
      clearInterval(timer);
      timer = null;
    }
  }

  start();

  if (examsTabBtn) {
    examsTabBtn.addEventListener('shown.bs.tab', refreshExams);
  }

  document.addEventListener('visibilitychange', function () {
    if (document.hidden) stop();
    else start();
  });
});
</script>

<!-- Script to make exams tab auto refresh -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  var examsTabBtn = document.getElementById('exams-tab');
  var examsPane   = document.getElementById('exams-pane');
  var indicator   = document.getElementById('exams-refresh-indicator');

  if (!examsPane) return;
  var timer = null;

  function isPaneActive() {
    return examsPane.classList.contains('active') && examsPane.classList.contains('show');
  }
  function isUserInteracting() {
    if (examsPane.matches(':hover')) return true;
    var ae = document.activeElement;
    return !!(ae && examsPane.contains(ae));
  }
  function showIndicator(on) {
    if (indicator) indicator.style.opacity = on ? '1' : '0';
  }

  async function refreshExams() {
    if (!isPaneActive()) return;
    if (isUserInteracting()) return;
    console.log('[ExamsRefresh] refreshing‚Ä¶');
    showIndicator(true);
    try {
      var url = window.location.href.split('#')[0];
      var res = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), {
        cache: 'no-store',
        headers: { 'X-Requested-With': 'fetch' }
      });
      if (!res.ok) return;
      var html = await res.text();
      var tmp = document.createElement('div');
      tmp.innerHTML = html;
      var freshPane = tmp.querySelector('#exams-pane');
      if (!freshPane) return;
      var freshSections = freshPane.querySelectorAll('.accordion-collapse[id^="ex-c-"]');
      freshSections.forEach(function (freshSection) {
        var id = freshSection.id;
        var currentSection = examsPane.querySelector('#' + CSS.escape(id));
        if (!currentSection) return;
        var freshTbody = freshSection.querySelector('table tbody');
        var currTbody  = currentSection.querySelector('table tbody');
        if (freshTbody && currTbody && currTbody.innerHTML.trim() !== freshTbody.innerHTML.trim()) {
          currTbody.innerHTML = freshTbody.innerHTML;
        }
      });
      console.log('[ExamsRefresh] done');
    } catch (e) {
      console.log('[ExamsRefresh] error:', e);
    } finally {
      setTimeout(() => showIndicator(false), 300);
    }
  }

  function start() {
    if (!timer) timer = setInterval(refreshExams, 5000);
  }
  function stop() {
    if (timer) { clearInterval(timer); timer = null; }
  }
  start();
  if (examsTabBtn) examsTabBtn.addEventListener('shown.bs.tab', refreshExams);
    document.addEventListener('visibilitychange', function () {
    if (document.hidden) stop(); else start();
  });

  // Restart refresh when mouse leaves the exams pane
  examsPane.addEventListener('mouseleave', function () {
    if (isPaneActive()) {
      console.log('[ExamsRefresh] mouse left exams pane ‚Äî resuming refresh');
      start();
    }
  });

  // Pause when mouse enters the exams pane
  examsPane.addEventListener('mouseenter', function () {
    console.log('[ExamsRefresh] mouse entered exams pane ‚Äî pausing refresh');
    stop();
  });
});
</script>

<style>
.fee-reveal-wrap { position: relative; display: inline-block; }

.fee-popover {
  position: absolute;
  top: 100%;
  left: 0;
  min-width: 200px;
  background: #212529;
  color: #fff;
  border-radius: .5rem;
  padding: .5rem .75rem;
  opacity: 0;
  transform: translateY(-5px);
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease;
  z-index: 999;
}

.fee-popover.show {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('reveal-fee-btn');
  const pop = document.getElementById('fee-popover');
  const txt = document.getElementById('fee-text');
  if (!btn || !pop || !txt) return;

  let hideTimer = null;

  function showPopover(message) {
    txt.innerHTML = message;
    pop.classList.add('show');
    clearTimeout(hideTimer);
    hideTimer = setTimeout(hidePopover, 4000);
  }

  function hidePopover() {
    pop.classList.remove('show');
  }

  document.addEventListener('click', e => {
    if (!pop.contains(e.target) && !btn.contains(e.target)) hidePopover();
  });

  btn.addEventListener('click', async () => {
    const url = btn.dataset.feeUrl;
    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) {
        showPopover(res.status === 403 ? 'Access denied.' : 'Error loading fee');
        return;
      }
      const data = await res.json();
      let message = 'Your fee: ' + data.amount;

      // Mileage ‚Äî keep on one line
      if (data.mileage) {
          message += '<br><span style="white-space: nowrap;">Mileage allowance: ' + data.mileage + '</span>';
      }

      // Accommodation ‚úì ‚Äî only if allowed
      if (data.accommodation) {
          message += '<br><span style="white-space: nowrap;">Accommodation: ‚úì</span>';
      }

      // Render as HTML
      txt.innerHTML = message;
      showPopover(message);

    } catch (err) {
      console.error(err);
      showPopover('Error loading fee');
    }
  });
});
</script>

<style>
  .btn-google-cal {
    background-color: #1A73E8;   /* Google blue */
    color: white;
    border-color: #1A73E8;
  }
  .btn-google-cal:hover {
    background-color: #1669C1;
    border-color: #1669C1;
    color: #fff;
  }
</style>
<style>
/* Remove ugly focus outline after auto-submit */
#closure-form:focus,
#closure-form *:focus {
  outline: none !important;
  box-shadow: none !important;
}
</style>

<style>
/* ‚úÖ KILL ALL AUTO-SUBMIT FOCUS RINGS & BORDERS */
#closure-form,
#closure-form * {
  outline: none !important;
  box-shadow: none !important;
}

#closure-form:focus,
#closure-form *:focus,
#closure-form *:focus-visible {
  outline: none !important;
  box-shadow: none !important;
  border-color: #dee2e6 !important;  /* Bootstrap normal border */
}
</style>

{% endblock %}
