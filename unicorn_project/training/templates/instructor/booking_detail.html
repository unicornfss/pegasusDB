{% extends "base.html" %}
{% load dict_extras %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-2 d-flex align-items-center gap-2">
  {{ booking.course_type.name }}
  {% if booking.course_reference %}
    <span class="badge bg-light text-dark border">Ref: {{ booking.course_reference }}</span>
  {% endif %}
</h3>

{% with st=booking.status %}
  {% if st == "scheduled" %}
    <span class="badge bg-info text-dark mb-3">Scheduled</span>
  {% elif st == "in_progress" %}
    <span class="badge bg-dark mb-3">In progress</span>
  {% elif st == "awaiting_closure" %}
    <span class="badge mb-3" style="background-color:#6f42c1;color:#fff">Awaiting instructor closure</span>
  {% elif st == "completed" %}
    <span class="badge bg-success mb-3">Completed</span>
  {% elif st == "cancelled" %}
    <span class="badge bg-warning text-dark mb-3">Cancelled</span>
  {% else %}
    <span class="badge bg-secondary mb-3">{{ booking.get_status_display|default:booking.status }}</span>
  {% endif %}
{% endwith %}

{% if is_locked %}
  <div class="alert alert-warning d-flex align-items-center gap-2">
    <i class="bi bi-lock"></i>
    This course is closed. All tabs are read-only except <strong>Invoicing</strong>.
  </div>
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-4">

      {# LEFT COLUMN ------------------------------------------------------- #}
      <div class="col-lg-4">
        <div class="mb-3">
          <div class="text-muted small">Business</div>
          <div>{{ booking.business.name }}</div>
        </div>

        <div>
          <div class="text-muted small">Location</div>
          <div>
            {{ booking.training_location.name|default:"(TBC)" }}<br>
            {% if booking.training_location %}
              {{ booking.training_location.address_line }}<br>
              {{ booking.training_location.town }} {{ booking.training_location.postcode }}<br>
              {% with addr=booking.training_location.address_line|add:", "|add:booking.training_location.town|add:" "|add:booking.training_location.postcode %}
                <a class="small" target="_blank" rel="noopener"
                   href="https://www.google.com/maps/search/?api=1&query={{ addr|urlencode }}">
                  View in Google Maps
                </a>
              {% endwith %}
            {% endif %}
          </div>
        </div>
      </div>

      {# MIDDLE COLUMN ----------------------------------------------------- #}
      <div class="col-lg-4">
        <div class="mb-3">
          <div class="text-muted small">Instructor</div>
          <div>{{ booking.instructor.name }}</div>
        </div>

        <div class="mb-3">
          <div class="text-muted small">Location contact</div>
          {% if booking.training_location %}
            <div>
              {{ booking.training_location.contact_name|default:"—" }}<br>
              {% if booking.training_location.telephone %}
                <a href="tel:{{ booking.training_location.telephone }}">
                  {{ booking.training_location.telephone }}
                </a><br>
              {% endif %}
              {% if booking.training_location.email %}
                <a href="mailto:{{ booking.training_location.email }}">
                  {{ booking.training_location.email }}
                </a>
              {% endif %}
            </div>
          {% else %}
            <div>—</div>
          {% endif %}
        </div>      
      </div>

      {# RIGHT COLUMN (NOTES) ---------------------------------------------- #}
      <div class="col-lg-4">
        <form method="post" class="h-100 d-flex flex-column">
          {% csrf_token %}
          <input type="hidden" name="action" value="save_notes">
          <div class="mb-2 text-muted small">Course notes</div>

          {% if is_locked %}
            {{ notes_form.booking_notes }}
            <script>
              document.addEventListener('DOMContentLoaded', function(){
                var ta = document.getElementById('id_booking_notes');
                if (ta){ ta.setAttribute('readonly','readonly'); ta.classList.add('bg-light'); }
              });
            </script>
          {% else %}
            {{ notes_form.booking_notes }}
          {% endif %}
          {% for err in notes_form.booking_notes.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
          {% if not is_locked %}
            <div class="mt-2">
              <button class="btn btn-primary btn-sm">
                <i class="bi bi-check2"></i> Save notes
              </button>
            </div>
          {% endif %}
        </form>
      </div>

    </div>
  </div>
</div>

<ul class="nav nav-tabs mt-3" id="bookingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="days-tab" data-bs-toggle="tab"
            data-bs-target="#days-pane" type="button" role="tab"
            aria-controls="days-pane" aria-selected="true">
      Course days / registers
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="assessments-tab" data-bs-toggle="tab"
            data-bs-target="#assessments-pane" type="button" role="tab"
            aria-controls="assessments-pane" aria-selected="false">
      Assessments
    </button>
  </li>

  {% if has_exam %}
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="exams-tab" data-bs-toggle="tab"
            data-bs-target="#exams-pane" type="button" role="tab"
            aria-controls="exams-pane" aria-selected="false">
      Exams
    </button>
  </li>
  {% endif %}

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="feedback-tab" data-bs-toggle="tab"
            data-bs-target="#feedback-pane" type="button" role="tab"
            aria-controls="feedback-pane" aria-selected="false">
      Feedback
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="closure-tab" data-bs-toggle="tab"
            data-bs-target="#closure-pane" type="button" role="tab"
            aria-controls="closure-pane" aria-selected="false">
      Course closure
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="invoicing-tab" data-bs-toggle="tab"
            data-bs-target="#invoicing-pane" type="button" role="tab"
            aria-controls="invoicing-pane" aria-selected="false">
      Invoicing
    </button>
  </li>
</ul>

<div class="tab-content border border-top-0 rounded-bottom p-3" id="bookingTabsContent">
  <!-- Pane: Course days / registers -->
  <div class="tab-pane fade show active" id="days-pane" role="tabpanel" aria-labelledby="days-tab" tabindex="0">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:160px">Date</th>
            <th style="width:120px">Start</th>
            <th style="width:120px" class="text-center">Delegates</th>
            <th style="width:160px" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for d in day_rows %}
              <tr class="{% if d.warn %}table-warning{% endif %}">
              <td>{{ d.date }}</td>
              <td>{% if d.start_time %}{{ d.start_time|time:"H:i" }}{% else %}—{% endif %}</td>
              <td class="text-center"><span class="badge bg-secondary">{{ d.n }}</span></td>
              <td class="text-end">
                <a class="btn btn-outline-primary btn-sm" href="{{ d.edit_url }}">
                  <i class="bi bi-people"></i> View / edit
                </a>
              </td>
            </tr>
              {% if d.warn %}
                <tr class="table-warning">
                  <td colspan="4" class="small text-danger">
                    ⚠️ Date of birth mismatch detected on this register
                    ({{ d.warn_count }} item{{ d.warn_count|pluralize }}).
                    Please open the register and correct the affected delegate(s).
                  </td>
                </tr>
              {% endif %}


          {% empty %}
            <tr><td colspan="4" class="text-muted">No days created for this booking.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pane: Assessments -->
  <div class="tab-pane fade" id="assessments-pane" role="tabpanel" aria-labelledby="assessments-tab" tabindex="0">
    {% include "instructor/_assessment_matrix_inner.html" %}
  </div>

  {% if has_exam %}
  <!-- Pane: Exams (only when course type has exams) -->
  <div class="tab-pane fade" id="exams-pane" role="tabpanel" aria-labelledby="exams-tab" tabindex="0">
     <div id="exams-refresh-indicator" class="text-end small text-muted" style="opacity:0; transition:opacity .25s;">Updating…</div>

    {% if course_exams %}

      <div class="alert alert-info py-2 small" style="font-size:0.85rem;">
        <strong>Note:</strong> Live exam results refresh automatically when you are not interacting with this section.<br>
        Move your mouse away from the table to allow refreshing.
      </div>

      <div class="accordion" id="examAccordion">

        {% for ex in course_exams %}
          {% with seq=ex.sequence code=ex.exam_code %}
          <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="ex-h-{{ seq }}">
              <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                      data-bs-toggle="collapse" data-bs-target="#ex-c-{{ seq }}"
                      aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                      aria-controls="ex-c-{{ seq }}">
                Exam {{ seq }} — {{ ex.title }} <span class="ms-2 small text-muted">({{ code }})</span>
              </button>
            </h2>
            <div id="ex-c-{{ seq }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                 aria-labelledby="ex-h-{{ seq }}" data-bs-parent="#examAccordion">
              <div class="accordion-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm align-middle m-0">
                    <thead>
                      <tr>
                        <th>Delegate</th>
                        <th style="width: 120px;">DOB</th>
                        <th style="width: 90px;">Attempt</th>
                        <th style="width: 110px;" class="text-center">Score</th>
                        <th style="width: 90px;"  class="text-center">%</th>
                        <th style="width: 120px;">Result</th>
                        <th class="text-end" style="width: 260px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% with atts=attempts_by_exam|get_item:seq %}
                        {% if atts %}
                          {% for att in atts %}
                            <tr>
                              <td>{{ att.delegate_name|default:"Delegate" }}</td>
                              <td>
                                {% if att.date_of_birth %}
                                  {{ att.date_of_birth|date:"j M Y" }}
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>
                              <td>{{ att.attempt_number|default:"1" }}</td>

                              <!-- Score (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at %}
                                  {% if att.total_questions %}
                                    {{ att.score_correct }}/{{ att.total_questions }}
                                  {% else %}
                                    {{ att.score_correct }}
                                  {% endif %}
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>

                              <!-- Percentage (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at and att.total_questions %}
                                  {% widthratio att.score_correct att.total_questions 100 %}%
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>

                              <td>
                                {% if att.finished_at %}
                                  {% if att.passed %}
                                    <span class="badge bg-success">Pass</span>
                                  {% elif att.viva_eligible %}
                                    <span class="badge bg-warning text-dark">Viva</span>
                                  {% else %}
                                    <span class="badge bg-danger">Fail</span>
                                  {% endif %}
                                {% else %}
                                  <span class="badge bg-info text-dark">In progress</span>
                                {% endif %}
                              </td>
                              <td class="text-end">

                                <a class="btn btn-sm btn-outline-primary"
                                  href="{% url 'instructor_attempt_review' att.id %}?back={{ booking.id }}&tab=exams">
                                  Review exam
                                </a>

                                <a class="btn btn-sm btn-outline-secondary"
                                  href="{% url 'instructor_attempt_incorrect' att.id %}?back={{ booking.id }}&tab=exams">
                                  See incorrect & authorise re-test
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        {% else %}
                          <tr><td colspan="7" class="text-muted p-3">No attempts yet for this exam.</td></tr>
                        {% endif %}
                      {% endwith %}
                    </tbody>

                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info my-2">No exams defined for this course type.</div>
    {% endif %}

  </div>
{% endif %}


  <!-- Pane: Feedback (loads your booking_feedback.html) -->
  <div class="tab-pane fade" id="feedback-pane" role="tabpanel" aria-labelledby="feedback-tab" tabindex="0">
    {% include "instructor/booking_feedback.html" %}
  </div>

  <!-- Pane: Course closure -->
  <div class="tab-pane fade" id="closure-pane" role="tabpanel" aria-labelledby="closure-tab" tabindex="0">
    <!-- Registers status -->
    <div class="row g-3 align-items-center mb-3">
      <div class="col-auto">
        <div class="text-muted small">Register status</div>
        <span id="closure-register-status"
              class="badge {% if registers_all_days %}bg-success{% elif reg_manual %}bg-primary{% else %}bg-warning text-dark{% endif %}">
          {% if registers_all_days %}OK{% elif reg_manual %}Manual submission(s){% else %}Not complete{% endif %}
        </span>
      </div>
      <div class="col-auto">
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="closure-register-manual"
                {% if registers_all_days %}disabled{% endif %}
                {% if reg_manual and not registers_all_days %}checked{% endif %}>
          <label class="form-check-label" for="closure-register-manual">
            Manual submission to follow
          </label>
        </div>
      </div>
    </div>

    <!-- Assessments status -->
    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <div class="text-muted small">Assessments status</div>
        <span id="assessments-status-pill"
              class="badge {% if assessments_all_complete %}bg-success{% elif assess_manual %}bg-primary{% else %}bg-warning text-dark{% endif %}">
          {% if assessments_all_complete %}OK{% elif assess_manual %}Manual submission(s){% else %}Delegate(s) still &quot;Pending&quot; on matrix{% endif %}
        </span>
      </div>
      <div class="col-auto">
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="closure-assess-manual"
                {% if assessments_all_complete %}disabled{% endif %}
                {% if assess_manual and not assessments_all_complete %}checked{% endif %}>
          <label class="form-check-label" for="closure-assess-manual">
            Manual submission to follow
          </label>
        </div>
      </div>
    </div>

    {% if not is_locked %}
      <form id="close-course-form" method="post" class="mt-3">
        {% csrf_token %}
        <input type="hidden" name="action" value="close_course">

        <!-- manual flags -->
        <input type="hidden" id="hf-reg-manual"    name="reg_manual"       value="{{ reg_manual|yesno:'1,0' }}">
        <input type="hidden" id="hf-assess-manual" name="assess_manual"    value="{{ assess_manual|yesno:'1,0' }}">

        <!-- current OK states as seen in the UI -->
        <input type="hidden" id="hf-registers-ok"   name="registers_ok"   value="{{ registers_all_days|yesno:'1,0' }}">
        <input type="hidden" id="hf-assessments-ok" name="assessments_ok" value="{{ assessments_all_complete|yesno:'1,0' }}">

        <button type="submit" id="close-course-btn" class="btn btn-danger"
                {% if not can_close_course %}disabled{% endif %}>
          <i class="bi bi-check2-circle"></i> Close course and prepare invoice
        </button>
      </form>
    {% else %}
      <div class="mt-3 alert alert-info">
        Course already closed — proceed to the <strong>Invoicing</strong> tab.
      </div>
    {% endif %}
  </div>


   <!-- Pane: Invoicing -->
  <div class="tab-pane fade" id="invoicing-pane" role="tabpanel" aria-labelledby="invoicing-tab" tabindex="0">
    {% include "instructor/_invoicing_tab.html" %}
  </div>
</div>

<a href="{{ back_url }}" class="btn btn-secondary">Back to My bookings</a>

<a href="{{ back_url }}" class="btn btn-secondary">Back to My bookings</a>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- elements we touch on the closure tab ---
  const REG_PILL        = document.getElementById("closure-register-status");
  const ASSESS_PILL     = document.getElementById("assessments-status-pill");
  const CLOSE_BTN       = document.getElementById("close-course-btn");
  const REG_MANUAL_CB   = document.getElementById("closure-register-manual");
  const ASSESS_MANUAL_CB= document.getElementById("closure-assess-manual");
  const REG_MANUAL_HF   = document.getElementById("hf-reg-manual");
  const ASSESS_MANUAL_HF= document.getElementById("hf-assess-manual");

  // ---- helpers ----
  function outcomeCellComplete(cell) {
    if (!cell) return false;
    // “Pass” badge present?
    if (cell.querySelector('.badge') && /pass/i.test(cell.textContent)) return true;
    // Or manual select set to DNF/Fail
    const sel = cell.querySelector('select[name^="outcome_"]');
    if (!sel) return false;
    const v = (sel.value || "").toLowerCase();
    return v === "dnf" || v === "fail";
  }

  function assessmentsCompleteNow() {
    const cells = Array.from(document.querySelectorAll('.outcome-cell'));
    if (!cells.length) return false;
    return cells.every(outcomeCellComplete);
  }

  function registersCompleteNow() {
    return !!(REG_PILL && REG_PILL.classList.contains("bg-success"));
  }

  function setAssessBadge(ok) {
    if (!ASSESS_PILL) return;
    ASSESS_PILL.className = ok ? "badge bg-success"
                               : "badge bg-warning text-dark";
    ASSESS_PILL.textContent = ok ? "OK" : 'Delegate(s) still "Pending" on matrix';
  }

  function refreshClosureStateImmediate() {
    const assessComplete = assessmentsCompleteNow();
    const regsComplete   = registersCompleteNow();

    // badge + manual toggle for assessments
    setAssessBadge(assessComplete);
    if (ASSESS_MANUAL_CB) {
      ASSESS_MANUAL_CB.disabled = assessComplete;
      if (ASSESS_MANUAL_HF) {
        ASSESS_MANUAL_HF.value = assessComplete ? "0" : (ASSESS_MANUAL_CB.checked ? "1" : "0");
      }
      if (assessComplete) ASSESS_MANUAL_CB.checked = false;
    }

    // manual toggle for registers
    if (REG_MANUAL_CB) {
      REG_MANUAL_CB.disabled = regsComplete;
      if (REG_MANUAL_HF) {
        REG_MANUAL_HF.value = regsComplete ? "0" : (REG_MANUAL_CB.checked ? "1" : "0");
      }
      if (regsComplete) REG_MANUAL_CB.checked = false;
    }

    // enable button if (regs OK or manual) AND (assess OK or manual)
    const canClose = (regsComplete   || (REG_MANUAL_CB    && REG_MANUAL_CB.checked)) &&
                     (assessComplete || (ASSESS_MANUAL_CB && ASSESS_MANUAL_CB.checked));
    if (CLOSE_BTN) CLOSE_BTN.disabled = !canClose;
  }

  // Expose a single hook the assessments matrix can call with payloads
  // (we still recompute from the DOM afterwards).
  window.applyClosurePayload = function (payload) {
    if (payload && typeof payload === "object") {
      if (payload.hasOwnProperty("assessments_complete")) {
        setAssessBadge(!!payload.assessments_complete);
      }
    }
    refreshClosureStateImmediate();
  };

  // React to matrix changes + manual checkboxes
  document.addEventListener("change", function (e) {
    const t = e.target;
    if (!t) return;
    if (t.matches('.outcome-cell select[name^="outcome_"]')) {
      refreshClosureStateImmediate();
    } else if (t.matches('.cell input[type="checkbox"][name^="level_"]')) {
      refreshClosureStateImmediate();
    } else if (t === ASSESS_MANUAL_CB) {
      if (ASSESS_MANUAL_HF) ASSESS_MANUAL_HF.value = ASSESS_MANUAL_CB.checked ? "1" : "0";
      refreshClosureStateImmediate();
    } else if (t === REG_MANUAL_CB) {
      if (REG_MANUAL_HF) REG_MANUAL_HF.value = REG_MANUAL_CB.checked ? "1" : "0";
      refreshClosureStateImmediate();
    }
  });

  // When switching between Assessments/Closure tabs, recompute
  document.addEventListener('shown.bs.tab', function (ev) {
    const targetPane = ev.target?.getAttribute('data-bs-target') || "";
    if (targetPane === '#assessments-pane' || targetPane === '#closure-pane') {
      refreshClosureStateImmediate();
    }
  });

  // Initial compute
  refreshClosureStateImmediate();
});
</script>


{% endblock %}
