{% extends "base.html" %}
{% load dict_extras %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<h3 class="mb-2 d-flex align-items-center gap-2">
  {{ title }}
  {% if booking %}
    {% with st=booking.status %}
      {% if st == "scheduled" %}
        <span class="badge bg-info text-dark">Scheduled</span>
      {% elif st == "in_progress" %}
        <span class="badge bg-dark">In progress</span>
      {% elif st == "awaiting_closure" %}
        <span class="badge" style="background-color:#6f42c1;color:#fff">Awaiting instructor closure</span>
      {% elif st == "completed" %}
        <span class="badge bg-success">Completed</span>
      {% elif st == "cancelled" %}
        <span class="badge bg-warning text-dark">Cancelled</span>
      {% else %}
        <span class="badge bg-secondary">{{ booking.get_status_display|default:booking.status }}</span>
      {% endif %}
    {% endwith %}
  {% endif %}
</h3>

{% if unlock_url and booking %}
  {% if booking.status == "completed" %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong>Booking is completed.</strong> Instructors cannot edit registers/assessments.
        You can unlock it to return the status to <em>Awaiting instructor closure</em>.
      </div>
      <a href="{{ unlock_url }}" class="btn btn-warning">
        <i class="bi bi-unlock"></i> Unlock for instructor editing
      </a>
    </div>
  {% endif %}
{% endif %}

<form id="booking-form" method="post" class="card p-3">
  {% csrf_token %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
    </div>
  {% endif %}

  <div class="row g-3">
    <!-- Course details -->
    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header">Course details</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Business *</label>
              {{ form.business }}
              {% for err in form.business.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-12">
              <label class="form-label">Training location *</label>
              {{ form.training_location }}
              {% for err in form.training_location.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
              <div id="loc-address-text" class="form-text mt-1"></div>
            </div>

            <div class="col-md-12">
              <label class="form-label">Course type *</label>
              <select name="{{ form.course_type.html_name }}" id="{{ form.course_type.id_for_label }}" class="form-select">
                <option value="">— Select a course type —</option>
                {% for ct in form.fields.course_type.queryset %}
                  <option value="{{ ct.pk }}"
                    {% if form.is_bound and form.data.course_type == ct.pk|stringformat:"s" %}
                      selected
                    {% elif not form.is_bound and form.instance and form.instance.course_type_id == ct.pk %}
                      selected
                    {% elif not form.is_bound and form.initial.course_type == ct.pk|stringformat:"s" %}
                      selected
                    {% endif %}
                    data-duration="{{ ct.duration_days }}"
                    data-course-fee="{{ ct.default_course_fee }}"
                    data-instructor-fee="{{ ct.default_instructor_fee }}"
                    data-code="{{ ct.code|default_if_none:'' }}"
                  >{{ ct.name }}</option>
                {% endfor %}
              </select>
              {% for err in form.course_type.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Course date *</label>
              {{ form.course_date }}
              {% for err in form.course_date.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Start time *</label>
              {{ form.start_time }}
              {% for err in form.start_time.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-12">
              <label class="form-label">Course reference</label>
              {{ form.course_reference }}
              {% for err in form.course_reference.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructor & contact -->
    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header">Instructor &amp; contact</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Instructor</label>
              {{ form.instructor }}
              {% for err in form.instructor.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label">Course fee</label>
              {{ form.course_fee }}
              {% for err in form.course_fee.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Instructor fee</label>
              {{ form.instructor_fee }}
              {% for err in form.instructor_fee.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Contact name</label>
              {{ form.contact_name }}
              {% for err in form.contact_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Telephone</label>
              {{ form.telephone }}
              {% for err in form.telephone.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              {{ form.email }}
              {% for err in form.email.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Course days + notes row -->
  </div><!-- end main details row -->

  <div class="row g-3 mt-3">

    <!-- Course days -->
    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header">Course days</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:110px">Day #</th>
                  <th style="width:220px">Date</th>
                  <th style="width:160px">Start</th>
                  <th style="width:160px">End</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="booking-days"></tbody>
            </table>
          </div>

          <!-- Hidden JSON payload for inline days -->
          <input type="hidden" name="booking_days" id="booking-days-json">
          <input type="hidden" name="days_json"     id="booking-days-json-mirror">
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="col-12 col-xl-6">
      <div class="card h-100">
        <div class="card-header">Course notes</div>
        <div class="card-body">
          <label class="form-label">Comments</label>
          {{ form.booking_notes }}
          {% for err in form.booking_notes.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>
      </div>
    </div>

  </div>

  {% if booking %}
    <hr class="my-4">

    <!-- Tabbed views -->
    <ul class="nav nav-tabs" id="bookingTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'registers' %}active{% endif %}"
            id="tab-registers"
            data-bs-toggle="tab" data-bs-target="#tab-pane-registers"
            type="button" role="tab" aria-controls="tab-pane-registers"
            aria-selected="{% if active_tab == 'registers' %}true{% else %}false{% endif %}">
      Registers
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'assessments' %}active{% endif %}"
            id="tab-assessments"
            data-bs-toggle="tab" data-bs-target="#tab-pane-assessments"
            type="button" role="tab" aria-controls="tab-pane-assessments"
            aria-selected="{% if active_tab == 'assessments' %}true{% else %}false{% endif %}">
      Assessments
    </button>
  </li>
    {% if has_exam %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'exams' %}active{% endif %}"
              id="tab-exams" data-bs-toggle="tab"
              data-bs-target="#tab-pane-exams" type="button" role="tab"
              aria-controls="tab-pane-exams"
              aria-selected="{% if active_tab == 'exams' %}true{% else %}false{% endif %}">
        Exams
      </button>
    </li>
    {% endif %}

  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'feedback' %}active{% endif %}"
            id="tab-feedback"
            data-bs-toggle="tab" data-bs-target="#tab-pane-feedback"
            type="button" role="tab" aria-controls="tab-pane-feedback"
            aria-selected="{% if active_tab == 'feedback' %}true{% else %}false{% endif %}">
      Feedback
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'certificates' %}active{% endif %}"
            id="tab-certificates"
            data-bs-toggle="tab" data-bs-target="#tab-pane-certificates"
            type="button" role="tab" aria-controls="tab-pane-certificates"
            aria-selected="{% if active_tab == 'certificates' %}true{% else %}false{% endif %}">
      Certificates
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == 'invoice' %}active{% endif %}"
            id="tab-invoice"
            data-bs-toggle="tab" data-bs-target="#tab-pane-invoice"
            type="button" role="tab" aria-controls="tab-pane-invoice"
            aria-selected="{% if active_tab == 'invoice' %}true{% else %}false{% endif %}">
      Invoice
    </button>
  </li>
</ul>


    <div class="tab-content border border-top-0 p-3 rounded-bottom" id="bookingTabsContent">
      <!-- REGISTERS TAB -->
      <div class="tab-pane fade {% if active_tab == 'registers' %}show active{% endif %}"
          id="tab-pane-registers"
          role="tabpanel" aria-labelledby="tab-registers">


    <div class="row g-3">
      <!-- LEFT: list of days -->
      <div class="col-md-4">
        <h5 class="mb-3">Registers for each day</h5>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
  <tr>
    <th>Date</th>
    <th class="text-center">Delegates</th>
    <th class="text-end">Actions</th>
  </tr>
</thead>

            <tbody>
              {% for d in booking.days.all|dictsort:"date" %}
                {% with count=d.registers.count %}
                <tr>
                  <td>{{ d.date|date:"j M Y" }}</td>
                  <td class="text-center">
                    <span class="badge {% if count > 0 %}bg-primary{% else %}bg-secondary{% endif %}">
                      {{ count }}
                    </span>
                  </td>
                  <td class="text-end">
  <div class="btn-group btn-group-sm" role="group">
    <a href="{% url 'admin_booking_day_registers' d.id %}?inline=1"
       class="btn btn-outline-primary js-register-view"
       data-day-label="{{ d.date|date:'j M Y' }}">
      View
    </a>
    <a href="{% url 'instructor_day_registers_pdf' d.id %}"
       class="btn btn-outline-secondary"
       target="_blank" rel="noopener">
      PDF
    </a>
  </div>
</td>

                </tr>
                {% endwith %}
              {% empty %}
                <tr>
                  <td colspan="3" class="text-muted">No days yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: detail panel -->
      <div class="col-md-8">
        <div class="card h-100">
          <div class="card-header">
            Delegates
            <span id="register-detail-heading-extra" class="fw-normal"></span>
          </div>
          <div class="card-body" id="register-detail-body">
            <p class="text-muted mb-0">
              Select a day on the left to view its delegates.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- ASSESSMENTS TAB (read only) -->
  <div class="tab-pane fade {% if active_tab == 'assessments' %}show active{% endif %}"
      id="tab-pane-assessments"
      role="tabpanel" aria-labelledby="tab-assessments">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Assessment matrix</h5>
      {% if booking %}
        <a href="{% url 'instructor_assessment_pdf' booking.id %}"
          class="btn btn-danger btn-sm"
          target="_blank" rel="noopener">
            <i class="bi bi-file-earmark-pdf me-1"></i>
            Export PDF
        </a>

      {% endif %}
    </div>

    {% include "admin/_assessment_matrix_readonly.html" %}
  </div>

  {% if has_exam %}
  <!-- EXAMS TAB (read only) -->
  <div class="tab-pane fade {% if active_tab == 'exams' %}show active{% endif %}"
      id="tab-pane-exams"
      role="tabpanel" aria-labelledby="tab-exams">

    {% if course_exams %}
      <div class="alert alert-info py-2 small" style="font-size:0.85rem;">
        <strong>Note:</strong> This shows all submitted exam attempts for this course
        (read only).
      </div>

      <div class="accordion" id="adminExamAccordion">
        {% for ex in course_exams %}
          {% with seq=ex.sequence code=ex.exam_code %}
          <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="admin-ex-h-{{ seq }}">
              <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#admin-ex-c-{{ seq }}"
                      aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                      aria-controls="admin-ex-c-{{ seq }}">
                Exam {{ seq }} — {{ ex.title }}
                <span class="ms-2 small text-muted">({{ code }})</span>
              </button>
            </h2>

            <div id="admin-ex-c-{{ seq }}"
                class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                aria-labelledby="admin-ex-h-{{ seq }}"
                data-bs-parent="#adminExamAccordion">
              <div class="accordion-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm align-middle m-0">
                    <thead>
                      <tr>
                        <th>Delegate</th>
                        <th style="width: 120px;">DOB</th>
                        <th style="width: 90px;">Attempt</th>
                        <th style="width: 110px;" class="text-center">Score</th>
                        <th style="width: 90px;"  class="text-center">%</th>
                        <th style="width: 120px;">Result</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% with atts=attempts_by_exam|get_item:seq %}
                        {% if atts %}
                          {% for att in atts %}
                            <tr>
                              <td>{{ att.delegate_name|default:"Delegate" }}</td>
                              <td>
                                {% if att.date_of_birth %}
                                  {{ att.date_of_birth|date:"j M Y" }}
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>
                              <td>{{ att.attempt_number|default:"1" }}</td>

                              <!-- Score (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at %}
                                  {% if att.total_questions %}
                                    {{ att.score_correct }}/{{ att.total_questions }}
                                  {% else %}
                                    {{ att.score_correct }}
                                  {% endif %}
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>

                              <!-- Percentage (only when finished) -->
                              <td class="text-center">
                                {% if att.finished_at and att.total_questions %}
                                  {% widthratio att.score_correct att.total_questions 100 %}%
                                {% else %}
                                  <span class="text-muted">—</span>
                                {% endif %}
                              </td>

                              <!-- Result (badge, read-only) -->
                              <td>
                                {% if att.finished_at %}
                                  {% if att.passed %}
                                    <span class="badge bg-success">Pass</span>
                                  {% elif att.viva_eligible %}
                                    <span class="badge bg-warning text-dark">Viva</span>
                                  {% else %}
                                    <span class="badge bg-danger">Fail</span>
                                  {% endif %}
                                {% else %}
                                  <span class="badge bg-info text-dark">In progress</span>
                                {% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        {% else %}
                          <tr>
                            <td colspan="6" class="text-muted">
                              No exam attempts recorded for this exam yet.
                            </td>
                          </tr>
                        {% endif %}
                      {% endwith %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info my-2">
        No exams defined for this course type.
      </div>
    {% endif %}
  </div>
  {% endif %}


  <!-- FEEDBACK TAB (read only, same as instructor) -->
  <div class="tab-pane fade {% if active_tab == 'feedback' %}show active{% endif %}"
      id="tab-pane-feedback"
      role="tabpanel" aria-labelledby="tab-feedback">

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Feedback</h5>
      
    </div>

  {# Reuse the instructor's feedback layout, now that we pass booking/responses/summary #}
  {% include "instructor/booking_feedback.html" %}
</div>


    <!-- CERTIFICATES TAB -->
    <div class="tab-pane fade {% if active_tab == 'certificates' %}show active{% endif %}"
       id="tab-pane-certificates"
       role="tabpanel" aria-labelledby="tab-certificates">

    {% if booking %}
      {% if cert_delegates %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Certificates</h5>
          <div class="d-flex gap-2">
            {# existing “all certificates” (instructor) endpoint #}
            <a href="{% url 'instructor_booking_certificates' booking.id %}"
               class="btn btn-outline-secondary btn-sm"
               target="_blank" rel="noopener">
              All certificates (PDF)
            </a>
            <button type="button"
                    id="btn-cert-export"
                    class="btn btn-primary btn-sm">
              Export selected (PDF)
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:40px;"></th>
                <th>Delegate name (original)</th>
                <th style="width: 130px;">DOB</th>
                <th style="width: 230px;">Certificate name</th>
                <th style="width: 130px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for reg in cert_delegates %}
                <tr>
                  <td>
                    <input type="checkbox"
                           class="form-check-input cert-checkbox"
                           value="{{ reg.id }}">
                  </td>
                  <td>{{ reg.name }}</td>
                  <td>
                    {% if reg.date_of_birth %}
                      {{ reg.date_of_birth|date:"j M Y" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if reg.certificate_name %}
                      {{ reg.certificate_name }}
                      <span class="badge bg-info text-dark ms-1">override</span>
                    {% else %}
                      <span class="text-muted">Uses delegate name</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{% url 'admin_certificate_name_edit' reg.id %}"
                       class="btn btn-outline-secondary btn-sm">
                      Edit name
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">
          No delegates have passed this course yet, so no certificates are available.
        </p>
      {% endif %}
    {% else %}
      <p class="text-muted mb-0">Save the booking before managing certificates.</p>
    {% endif %}
  </div>

  <!-- INVOICE TAB (editable later) -->
  <div class="tab-pane fade {% if active_tab == 'invoice' %}show active{% endif %}"
       id="tab-pane-invoice"
       role="tabpanel" aria-labelledby="tab-invoice">
    <p class="text-muted mb-0">Invoice tab (editable) – content to be defined.</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const detailBody = document.getElementById('register-detail-body');
  const headingExtra = document.getElementById('register-detail-heading-extra');

  document.querySelectorAll('.js-register-view').forEach(function (btn) {
    btn.addEventListener('click', function (event) {
      event.preventDefault();

      const url = this.getAttribute('href');
      const dayLabel = this.getAttribute('data-day-label') || '';

      if (!detailBody) return;

      // Loading state
      detailBody.innerHTML = '<p class="text-muted mb-0">Loading…</p>';
      if (headingExtra) {
        headingExtra.textContent = dayLabel ? ' – ' + dayLabel : '';
      }

      fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }
          return response.text();
        })
        .then(function (html) {
          detailBody.innerHTML = html;
        })
        .catch(function (error) {
          console.error(error);
          detailBody.innerHTML =
            '<p class="text-danger mb-0">Could not load delegates. Please try again.</p>';
        });
    });
  });
});
</script>

  {% endif %}


  <div class="mt-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-primary" name="save_continue" value="1">
      <i class="bi bi-check2"></i> Save and continue editing
    </button>

    <button class="btn btn-success" name="save_return" value="1">
      <i class="bi bi-check2-circle"></i> Save and return
    </button>

    <a class="btn btn-secondary" href="{{ back_url }}">
      <i class="bi bi-x-circle"></i> Discard changes and go back
    </a>

    {% if booking %}
      {% if booking.status == 'cancelled' %}
        <a class="btn btn-warning" href="{% url 'admin_booking_reinstate' booking.id %}">
          <i class="bi bi-arrow-counterclockwise"></i> Reinstate
        </a>
      {% else %}
        <a class="btn btn-outline-danger" href="{% url 'admin_booking_cancel' booking.id %}">
          <i class="bi bi-slash-circle"></i> Cancel booking
        </a>
      {% endif %}
    {% endif %}

    {% if delete_url %}
      <a class="btn btn-outline-danger" href="{{ delete_url }}">
        <i class="bi bi-trash"></i> Delete
      </a>
    {% endif %}
  </div>
</form>

<script>
  /* ---- Data from view (safe defaults) ---- */
  const LOCATIONS     = {{ location_map_json|default:"{}"|safe }};
  const EXISTING_DAYS = {{ booking_days_initial_json|default:"[]"|safe }};

  /* NEW: capture initial values to protect existing references */
  const INIT_CT  = "{{ form.instance.course_type_id|default:'' }}";
  const INIT_REF = "{{ form.instance.course_reference|default:'' }}";
  let currentCT  = INIT_CT;

  /* ---- Small utilities ---- */
  const byName = (n) => document.querySelector(`[name="${n}"]`);
  const pad2   = (n) => String(n).padStart(2,'0');
  const toISO  = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseTime = (s) => s && /^\d{2}:\d{2}/.test(s) ? s.slice(0,5) : "";

  /* ---- Location helpers ---- */
  function clearContacts(){ const n=byName('contact_name'), p=byName('telephone'), e=byName('email'); if(n)n.value=''; if(p)p.value=''; if(e)e.value=''; }
  function clearAddress(){ const h=document.getElementById('loc-address-text'); if(!h) return; h.textContent=''; }
  function fillContactsFromRecord(rec){
    const n=byName('contact_name'), p=byName('telephone'), e=byName('email');
    if(!n||!p||!e) return;
    n.value = rec.contact_name || rec.contactName || rec.contact || '';
    p.value = rec.telephone || rec.phone || '';
    e.value = rec.email || '';
  }
  function setAddress(rec){
    const h=document.getElementById('loc-address-text'); if(!h) return;
    const line = rec.name || rec.address_line || rec.address || '';
    const town = rec.town || rec.city || '';
    const post = rec.postcode || rec.post_code || '';
    h.textContent = [line,town,post].filter(Boolean).join(', ');
  }
  function onLocationChange(){
    const sel = byName('training_location');
    if (!sel || !sel.value) { clearContacts(); clearAddress(); return; }
    const rec = LOCATIONS[sel.value];
    if (!rec) { clearContacts(); clearAddress(); return; }
    fillContactsFromRecord(rec); setAddress(rec);
  }
  function rebuildLocationOptions() {
    const bizSel = byName('business'), locSel = byName('training_location');
    if (!bizSel || !locSel) return;

    const bizId = String(bizSel.value || '');
    const prev  = String(locSel.value || '');

    locSel.innerHTML = '';
    const blank = document.createElement('option'); blank.value=''; blank.textContent='— Select a training location —';
    locSel.appendChild(blank);

    const items = Object.entries(LOCATIONS).filter(([id,x]) => String(x.business_id) === bizId);
    for (const [id,x] of items) {
      const o = document.createElement('option');
      o.value = String(id);
      o.textContent = (x.name || x.address_line || ('Location '+id));
      locSel.appendChild(o);
    }

    const real = Array.from(locSel.options).filter(o => o.value);
    if (prev && Array.from(locSel.options).some(o => o.value === prev)) {
      locSel.value = prev; onLocationChange(); return;
    }
    if (real.length === 0) { locSel.value=''; clearContacts(); clearAddress(); return; }
    if (real.length === 1) { const rec=LOCATIONS[real[0].value]; if(rec){fillContactsFromRecord(rec); setAddress(rec);} locSel.value=''; return; }
    locSel.value = real[0].value; onLocationChange();
  }

  /* ---- Days table helpers ---- */
  const $tbody = () => document.getElementById('booking-days');

  function addHoursToHHMM(hhmm, hoursFloat){
    if (!hhmm) return "";
    const [h, m] = hhmm.split(":").map(Number);
    const base = new Date(2000,0,1,h,m,0,0);
    const ms = Math.round(hoursFloat * 60 * 60 * 1000);
    const end = new Date(base.getTime() + ms);
    return `${String(end.getHours()).padStart(2,"0")}:${String(end.getMinutes()).padStart(2,"0")}`;
  }

  function getCourseSelect() {
    let el = document.getElementById("id_course_type");
    if (el) return el;
    el = document.querySelector('select[name="course_type"]');
    return el || null;
  }

  function getTotalDurationDays() {
    const sel = getCourseSelect();
    if (!sel) return 0;
    const opt = sel.options[sel.selectedIndex];
    const v = parseFloat(opt?.dataset?.duration || "0");
    return isNaN(v) ? 0 : v;
  }

  // 7h for whole days; 3.5h for fractional last day
  function durHoursForIndex(i, rows) {
    const total = getTotalDurationDays();
    const whole = Math.floor(total);
    const frac  = total - whole;

    if (rows === 1) return (total > 0 && total < 1) ? 3.5 : 7.0;
    if (i <= whole) return 7.0;
    if (frac > 0 && i === whole + 1) return 3.5;
    return 7.0;
  }

  function buildRows(count){
    const tb = $tbody(); if (!tb) return;
    tb.innerHTML = '';
    for (let i = 1; i <= count; i++) {
      const tr = document.createElement('tr');
      tr.dataset.index = i;

      const dateI = document.createElement('input');
      dateI.type = 'date';
      dateI.className = 'form-control form-control-sm';
      dateI.id = `day-${i}-date`;

      const stI = document.createElement('input');
      stI.type = 'time';
      stI.className = 'form-control form-control-sm';
      stI.id = `day-${i}-start`;

      const enI = document.createElement('input');
      enI.type = 'time';
      enI.className = 'form-control form-control-sm';
      enI.id = `day-${i}-end`;

      if (i === 1) { dateI.readOnly = true; stI.readOnly = true; dateI.title="Controlled by Course date above"; stI.title="Controlled by Start time above"; }

      const noteI = document.createElement('input');
      noteI.type = 'text';
      noteI.className = 'form-control form-control-sm';
      noteI.placeholder = '(optional)';
      noteI.id = `day-${i}-note`;

      const td0 = document.createElement('td'); td0.textContent = `Day ${i}`;
      const td1 = document.createElement('td'); td1.appendChild(dateI);
      const td2 = document.createElement('td'); td2.appendChild(stI);
      const td3 = document.createElement('td'); td3.appendChild(enI);
      const td4 = document.createElement('td'); td4.appendChild(noteI);

      tr.append(td0, td1, td2, td3, td4);
      tb.appendChild(tr);
    }
  }

  function buildFromExisting(days){
    const tb=$tbody(); if(!tb) return; tb.innerHTML="";
    days.forEach((d, idx)=>{
      const i = idx+1;
      const tr=document.createElement('tr'); tr.dataset.index=i;

      const dateI=document.createElement('input'); dateI.type='date'; dateI.className='form-control form-control-sm'; dateI.id=`day-${i}-date`; dateI.value=d.day_date||"";
      const stI  =document.createElement('input'); stI.type  ='time'; stI.className  ='form-control form-control-sm'; stI.id =`day-${i}-start`; stI.value=d.start_time||"";
      const enI  =document.createElement('input'); enI.type  ='time'; enI.className  ='form-control form-control-sm'; enI.id =`day-${i}-end`;   enI.value=d.end_time||"";

      if (i === 1) { dateI.readOnly = true; stI.readOnly = true; dateI.title="Controlled by Course date above"; stI.title="Controlled by Start time above"; }

      const noteI=document.createElement('input'); noteI.type='text'; noteI.className='form-control form-control-sm'; noteI.placeholder='(optional)';
      noteI.id = `day-${i}-note`;
      noteI.value = d.note || '';

      const td0=document.createElement('td'); td0.textContent=`Day ${i}`;
      const td1=document.createElement('td'); td1.appendChild(dateI);
      const td2=document.createElement('td'); td2.appendChild(stI);
      const td3=document.createElement('td'); td3.appendChild(enI);
      const td4=document.createElement('td'); td4.appendChild(noteI);
      tr.append(td0,td1,td2,td3,td4);
      tb.appendChild(tr);
    });
  }

  function populateFromHeader(){
    const tb=$tbody(); if(!tb) return; const rows=tb.children.length; if(!rows) return;
    const baseStr = byName('course_date')?.value || '';
    const startStr= parseTime(byName('start_time')?.value || '');
    if(!baseStr) return;

    const [Y,M,D] = baseStr.split('-').map(n=>parseInt(n,10));
    const base = new Date(Y, M-1, D);

    for(let i=1;i<=rows;i++){
      const d = new Date(base); d.setDate(base.getDate()+(i-1));
      const dEl=document.getElementById(`day-${i}-date`);
      const sEl=document.getElementById(`day-${i}-start`);
      const eEl=document.getElementById(`day-${i}-end`);

      if (i === 1) { if (dEl) dEl.value = toISO(d); if (sEl) sEl.value = startStr; }
      else { if(dEl && !dEl.value) dEl.value = toISO(d); if(sEl && !sEl.dataset.userEdited) sEl.value = startStr; }

      const durHours = durHoursForIndex(i, rows);
      const srcStart = sEl?.value || startStr || "";
      if (eEl && !eEl.dataset.userEdited) eEl.value = addHoursToHHMM(srcStart, durHours);
    }
  }

  document.addEventListener('input', (e)=>{
    if (e.target && /^day-\d+-start$/.test(e.target.id)) {
      const i = parseInt(e.target.id.match(/^day-(\d+)-start$/)[1], 10);
      const rows = $tbody()?.children.length || 1;
      if (i > 1) e.target.dataset.userEdited="1";
      const end = document.getElementById(`day-${i}-end`);
      if (end && !end.dataset.userEdited) {
        const durHours = durHoursForIndex(i, rows);
        end.value = addHoursToHHMM(e.target.value, durHours);
      }
    }
    if (e.target && /^day-\d+-end$/.test(e.target.id)) {
      e.target.dataset.userEdited="1";
    }
  });

  /* ----- SERIALISE ALL INLINE ROWS BEFORE SUBMIT ----- */
  function serializeDays() {
    const tb = document.getElementById('booking-days');
    if (!tb) return;

    const rows = Array.from(tb.children);
    const payload = rows.map((tr, idx) => {
      const i = idx + 1;
      return {
        day_index:  i,
        day_date:   document.getElementById(`day-${i}-date`)?.value || '',
        start_time: document.getElementById(`day-${i}-start`)?.value || '',
        end_time:   document.getElementById(`day-${i}-end`)?.value   || '',
        note:       document.getElementById(`day-${i}-note`)?.value  || ''
      };
    });

    const json = JSON.stringify(payload);
    const h1 = document.getElementById('booking-days-json');
    const h2 = document.getElementById('booking-days-json-mirror');
    if (h1) h1.value = json;
    if (h2) h2.value = json;
  }

  /* ---- Fees + reference helpers ---- */
  function getCTInfo(){
    const sel = getCourseSelect();
    if (!sel) return null;
    const opt = sel.options[sel.selectedIndex];
    if (!opt || !opt.value) return null;
    const durationRaw   = parseFloat(opt.dataset.duration || '0');
    const courseFeeRaw  = parseFloat(opt.dataset.courseFee || '0');
    const instrFeeRaw   = parseFloat(opt.dataset.instructorFee || '0');
    return {
      duration: isNaN(durationRaw) ? 0 : Math.ceil(durationRaw), // row count
      courseFee: isNaN(courseFeeRaw) ? 0 : courseFeeRaw,
      instructorFee: isNaN(instrFeeRaw) ? 0 : instrFeeRaw,
      code: (opt.dataset.code || '').toUpperCase()
    };
  }

  function applyCourseFeesFromType(force=false){
    const info = getCTInfo(); if(!info) return;
    const cf=byName('course_fee'), inf=byName('instructor_fee');
    if (cf  && (force || cf.value.trim()===""))  cf.value  = info.courseFee || '';
    if (inf && (force || inf.value.trim()==="")) inf.value = info.instructorFee || '';
  }

  /* NEW: safe reference generation */
  function buildRef(code){
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const rand = Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
    return `${(code || 'COURSE').toUpperCase()}-${rand}`;
  }

  function maybeGenerateReferenceOnCTChange(){
    const sel = getCourseSelect();
    const ref = byName('course_reference');
    if (!sel || !ref) return;

    const newCT   = sel.value || '';
    const newCode = (sel.options[sel.selectedIndex]?.dataset?.code || 'COURSE').toUpperCase();
    if (newCT === currentCT) return;  // no change

    const val = (ref.value || '').trim();
    const looksAuto = /^[A-Z]+-[A-Z0-9]{6}$/.test(val);

    if (val === '' || looksAuto) {
      ref.value = buildRef(newCode);
    }
    currentCT = newCT;
  }

  function handleCourseChanged(){
    rebuildDaysUI();
    populateFromHeader();
    applyCourseFeesFromType(true);
    // Only (maybe) regenerate reference when CT actually changes
    maybeGenerateReferenceOnCTChange();
  }

  function rebuildDaysUI(){
    if (Array.isArray(EXISTING_DAYS) && EXISTING_DAYS.length > 0) {
      buildFromExisting(EXISTING_DAYS);
      const d1 = EXISTING_DAYS[0];
      const topDate = byName('course_date');
      const topStart = byName('start_time');
      if (d1) {
        if (topDate  && !topDate.value  && d1.day_date)    topDate.value  = d1.day_date;
        if (topStart && !topStart.value && d1.start_time)  topStart.value = d1.start_time;
      }
      populateFromHeader();
      return;
    }
    const total = getTotalDurationDays();
    const n = Math.max(0, Math.ceil(total));
    const tb = $tbody(); if (!tb) return;
    tb.innerHTML = '';
    if (n > 0) buildRows(n);
    populateFromHeader();
    applyCourseFeesFromType();
    // NOTE: DO NOT auto-generate reference here; we only do it on CT change when safe.
  }

  /* ---- Global listeners ---- */
  document.addEventListener('change', (e) => {
    if (e.target.name === 'business')           rebuildLocationOptions();
    if (e.target.name === 'training_location')  onLocationChange();
    if (e.target.name === 'course_type')        handleCourseChanged();
    if (e.target.name === 'course_date')        populateFromHeader();
    if (e.target.name === 'start_time')         populateFromHeader();
  });

  document.addEventListener('DOMContentLoaded', () => {
    const locSel = byName('training_location'); if(locSel) locSel.setAttribute('autocomplete','off');
    rebuildLocationOptions();
    onLocationChange();

    const courseSel = getCourseSelect();
    if (courseSel) courseSel.addEventListener('change', handleCourseChanged);

    // Initial build; DO NOT regenerate course reference here
    rebuildDaysUI();
    populateFromHeader();
    applyCourseFeesFromType();

    // Keep the payload in sync and ensure it’s written before submit
    const form = document.getElementById('booking-form');
    if (form) form.addEventListener('submit', serializeDays);

    const daysTbody = document.getElementById('booking-days');
    if (daysTbody) {
      daysTbody.addEventListener('input', serializeDays);
      daysTbody.addEventListener('change', serializeDays);
    }

    // auto-grow notes textarea for nicer UX
    const notes = document.getElementById('{{ form.booking_notes.id_for_label }}');
    if (notes) {
      notes.addEventListener('input', () => {
        notes.style.height = 'auto';
        notes.style.height = (notes.scrollHeight) + 'px';
      });
      notes.dispatchEvent(new Event('input'));
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('btn-cert-export');
  if (!btn) return;

  btn.addEventListener('click', function () {
    const baseUrl = "{% url 'admin_booking_certificates_selected' booking.id %}";
    const params = [];

    document.querySelectorAll('#tab-pane-certificates input.cert-checkbox:checked')
      .forEach(function (cb) {
        params.push('delegate_id=' + encodeURIComponent(cb.value));
      });

    const url = params.length ? (baseUrl + '?' + params.join('&')) : baseUrl;

    // open in a new tab/window so the admin stays on the booking page
    window.open(url, '_blank');
  });
});
</script>

{% endblock %}