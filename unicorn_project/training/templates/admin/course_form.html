{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-3">{{ title }}</h3>

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags|default:'info' }}">{{ m }}</div>
  {% endfor %}
{% endif %}

<form method="post" novalidate>
  {% csrf_token %}

  <!-- ===== CourseType main fields ===== -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          {{ form.name }}
          {% for e in form.name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Code</label>
          {{ form.code }}
          {% for e in form.code.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Duration (days)</label>
          {{ form.duration_days }}
          {% for e in form.duration_days.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">Default course fee</label>
          {{ form.default_course_fee }}
          {% for e in form.default_course_fee.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">Default instructor fee</label>
          {{ form.default_instructor_fee }}
          {% for e in form.default_instructor_fee.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-3">
          <label class="form-label d-block">Has exam?</label>
          <div class="form-check">
            {{ form.has_exam }}
          </div>
          {% for e in form.has_exam.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Competencies inline formset ===== -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="mb-2">Competencies</h5>

      {{ formset.management_form }}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:8rem">Order</th>
              <th>Competency</th>
              <th style="width:12rem" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="comp-body">
            {% for f in formset.forms %}
              <tr class="comp-row">
                <td>
                  {{ f.sort_order }}
                  {% for e in f.sort_order.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                  <div class="btn-group btn-group-sm mt-1" role="group" aria-label="Reorder">
                    <button type="button" class="btn btn-outline-secondary js-move" data-dir="-1" title="Move up">▲</button>
                    <button type="button" class="btn btn-outline-secondary js-move" data-dir="1"  title="Move down">▼</button>
                  </div>
                </td>
                <td>
                  {{ f.name }}
                  {% for e in f.name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td class="text-end">
                  {% if formset.can_delete %}
                    <label class="btn btn-outline-danger btn-sm mb-0">
                      {{ f.DELETE }} Delete
                    </label>
                  {% endif %}
                  {{ f.id }} {# keep hidden id #}
                </td>
              </tr>
            {% empty %}
              <tr class="text-muted"><td colspan="3">No competencies yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Add button at the bottom-left -->
      <div class="d-flex justify-content-start">
        <button type="button" class="btn btn-outline-primary btn-sm" id="add-row">
          <i class="bi bi-plus-lg"></i> Add competency
        </button>
      </div>

      <!-- Empty form template for cloning -->
      <template id="empty-row">
        <tr class="comp-row">
          <td>
            __SORT__
            <div class="btn-group btn-group-sm mt-1" role="group" aria-label="Reorder">
              <button type="button" class="btn btn-outline-secondary js-move" data-dir="-1" title="Move up">▲</button>
              <button type="button" class="btn btn-outline-secondary js-move" data-dir="1"  title="Move down">▼</button>
            </div>
          </td>
          <td>__NAME__</td>
          <td class="text-end">__DEL__ __ID__</td>
        </tr>
      </template>
    </div>
  </div>

  <!-- Save / Cancel -->
  <div class="d-flex gap-2 mt-3">
    <button type="submit" name="save_continue" class="btn btn-primary">
      <i class="bi bi-check2"></i> Save and continue
    </button>
    <button type="submit" name="save_return" class="btn btn-success">
      <i class="bi bi-check2-circle"></i> Save and return
    </button>
    <a href="{% url 'admin_course_list' %}" class="btn btn-secondary">Cancel</a>
  </div>


</form>  {# ← THIS closes the form #}

<script>
(function(){
  const total = document.getElementById("id_comps-TOTAL_FORMS");
  const body  = document.getElementById("comp-body");
  const tmpl  = document.getElementById("empty-row");
  const addBtn= document.getElementById("add-row");
  if (!total || !tmpl || !body || !addBtn) return;

  function renumberSortOrder() {
    const rows = Array.from(body.querySelectorAll("tr.comp-row"));
    rows.forEach((tr, idx) => {
      const input = tr.querySelector('input[name$="-sort_order"]');
      if (input) input.value = String(idx);
    });
  }

  function wireMoveButtons(tr) {
    tr.querySelectorAll(".js-move").forEach(btn => {
      btn.addEventListener("click", function(){
        const dir = parseInt(this.dataset.dir, 10);
        const current = tr;
        if (dir < 0 && current.previousElementSibling) {
          body.insertBefore(current, current.previousElementSibling);
        } else if (dir > 0 && current.nextElementSibling) {
          body.insertBefore(current.nextElementSibling, current);
        }
        renumberSortOrder();
      });
    });
  }

  // Wire existing rows + normalize their order numbers immediately
  Array.from(body.querySelectorAll("tr.comp-row")).forEach(wireMoveButtons);
  renumberSortOrder();

  addBtn.addEventListener("click", function(){
    const idx = parseInt(total.value, 10);

    const ef = {
      sort:  `{{ formset.empty_form.sort_order|escapejs }}`.replace(/__prefix__/g, idx),
      name:  `{{ formset.empty_form.name|escapejs }}`.replace(/__prefix__/g, idx),
      del:   `{{ formset.empty_form.DELETE|escapejs }}`.replace(/__prefix__/g, idx),
      id:    `{{ formset.empty_form.id|escapejs }}`.replace(/__prefix__/g, idx),
    };

    let html = tmpl.innerHTML
      .replace("__SORT__",   ef.sort)
      .replace("__NAME__",   ef.name)
      .replace("__DEL__",    `<label class="btn btn-outline-danger btn-sm mb-0">${ef.del} Delete</label>`)
      .replace("__ID__",     ef.id);

    const wrap = document.createElement("tbody");
    wrap.innerHTML = html.trim();
    const row = wrap.firstElementChild;
    body.appendChild(row);

    renumberSortOrder();
    wireMoveButtons(row);
    total.value = String(idx + 1);
  });
})();
</script>
{% endblock %}
