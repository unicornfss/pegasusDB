{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<h3 class="mb-3">{{ title }}</h3>

<form method="post" class="mb-4">
  {% csrf_token %}
  <div class="row g-3">
    {% for field in form %}
      <div class="col-md-6">
        <label class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
        {{ field }}
        {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
        {% for err in field.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>
    {% endfor %}
  </div>

  {# Actions row #}
  <div class="mt-3 d-flex gap-2 align-items-center">
    <a href="{{ back_url }}" class="btn btn-outline-secondary">Back</a>

    <button class="btn btn-primary" type="submit" name="save_continue" value="1">
      Save and continue editing
    </button>

    <button class="btn btn-success" type="submit" name="save_return" value="1">
      Save and return
    </button>

    {% if business %}
      {# DELETE: submit this same form to the delete URL; skip validation; confirm first #}
      <button
        type="submit"
        class="btn btn-outline-danger ms-auto"
        formaction="{% url 'admin_business_delete' business.id %}"
        formmethod="post"
        formnovalidate
        onclick="return confirm('This will permanently delete this business. This cannot be undone.\n\nAre you sure you want to proceed?');">
        <i class="bi bi-trash"></i> Delete
      </button>
    {% endif %}
  </div>
</form>

{% if business %}
<div class="row g-3">

  <!-- LEFT: Training locations (50%) -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Training locations for <strong>{{ business.name }}</strong></span>
        {% if add_location_url %}
          <a class="btn btn-sm btn-success" href="{{ add_location_url }}">
            <i class="bi bi-plus-lg"></i> Add Location
          </a>
        {% endif %}
      </div>

      {% if locations %}
        <div class="list-group list-group-flush">
          {% for loc in locations %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
               href="{% url 'admin_location_edit' loc.id %}">
              <div>
                <div class="fw-semibold">{{ loc.name }}</div>
                <div class="small text-muted">
                  {{ loc.address_line }}{% if loc.town %}, {{ loc.town }}{% endif %}{% if loc.postcode %} {{ loc.postcode }}{% endif %}
                </div>
                {% if loc.contact_name or loc.telephone or loc.email %}
                  <div class="small">
                    {{ loc.contact_name }}{% if loc.telephone %} · {{ loc.telephone }}{% endif %}{% if loc.email %} · {{ loc.email }}{% endif %}
                  </div>
                {% endif %}
              </div>
              <span class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></span>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="card-body text-muted">
          No training locations yet. Tick “Add as training location” and save to auto-create one,
          or click <em>Add Location</em> to create another.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- RIGHT: Bookings (50%) — status tabs only -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
          <span>Bookings</span>
        </div>

        {# Status tabs (All + distinct statuses) #}
        <ul class="nav nav-pills mt-2" role="tablist">
          <li class="nav-item">
            <a class="nav-link {% if b_status|default:'all' == 'all' %}active{% endif %}"
               href="?b_status=all">All</a>
          </li>
          {% for st in booking_statuses %}
            {% if st %}
            <li class="nav-item">
              <a class="nav-link {% if b_status == st %}active{% endif %}"
                 href="?b_status={{ st }}">{{ st|capfirst }}</a>
            </li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>

      {% if bookings %}
        <div class="list-group list-group-flush">
          {% for b in bookings %}
            <a class="list-group-item list-group-item-action"
               href="{% url 'admin_booking_edit' b.id %}">
              <div class="fw-semibold">
                {{ b.course_type.name|default:b.course_type }}
                {% if b.training_location %} — {{ b.training_location.name|default:b.training_location }}{% endif %}
              </div>
              <div class="small text-muted">
                {% if b.course_date %}
                  {{ b.course_date|date:"d M Y" }}
                {% elif b.first_day %}
                  {{ b.first_day|date:"d M Y" }}
                {% endif %}
                {% if b.start_time %} at {{ b.start_time|time:"H:i" }}{% endif %}
                {% if b.instructor %} · {{ b.instructor.name|default:b.instructor }}{% endif %}
                {% if b.status %} · {{ b.status|capfirst }}{% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="card-body text-muted">
          No bookings{% if b_status and b_status != 'all' %} in "{{ b_status|capfirst }}"{% endif %}.
        </div>
      {% endif %}
    </div>
  </div>

</div>
{% endif %}

{% endblock %}
